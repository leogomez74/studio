<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cuestionario P√∫blico</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --background: 220 13% 97%;
            --foreground: 224 71.4% 4.1%;
            --card: 0 0% 100%;
            --card-foreground: 224 71.4% 4.1%;
            --primary: 209 78% 34%;
            --primary-foreground: 0 0% 100%;
            --secondary: 220 13% 91%;
            --secondary-foreground: 220 9% 38%;
            --muted: 220 13% 91%;
            --muted-foreground: 220 9% 45%;
            --accent: 220 14% 96%;
            --border: 220 13% 85%;
            --input: 220 13% 85%;
            --ring: 209 78% 34%;
            --radius: 0.5rem;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: hsl(var(--background));
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        headline: ['Space Grotesk', 'sans-serif'],
                    },
                    colors: {
                        background: 'hsl(var(--background))',
                        foreground: 'hsl(var(--foreground))',
                        card: 'hsl(var(--card))',
                        'card-foreground': 'hsl(var(--card-foreground))',
                        primary: 'hsl(var(--primary))',
                        'primary-foreground': 'hsl(var(--primary-foreground))',
                        secondary: 'hsl(var(--secondary))',
                        'secondary-foreground': 'hsl(var(--secondary-foreground))',
                        muted: 'hsl(var(--muted))',
                        'muted-foreground': 'hsl(var(--muted-foreground))',
                        accent: 'hsl(var(--accent))',
                        border: 'hsl(var(--border))',
                        input: 'hsl(var(--input))',
                        ring: 'hsl(var(--ring))',
                    },
                    borderRadius: {
                        lg: 'var(--radius)',
                        md: 'calc(var(--radius) - 2px)',
                        sm: 'calc(var(--radius) - 4px)',
                    }
                }
            }
        }
    </script>
</head>
<body class="min-h-screen flex items-center justify-center p-2 md:p-4">
    <div class="w-full max-w-3xl">
        <div id="alert" class="hidden p-4 mb-4 text-sm rounded-lg" role="alert"></div>

        <div class="bg-card text-card-foreground rounded-xl border shadow-lg">
            <div id="questionnaireHeader" class="p-4 md:p-6">
                <div class="text-center space-y-1">
                    <p class="text-xs font-semibold tracking-wide text-primary uppercase">Paso a paso</p>
                    <h1 class="text-2xl md:text-3xl font-headline font-bold text-primary">Cuestionario P√∫blico</h1>
                    <p class="text-muted-foreground text-sm md:text-base">¬°Queremos entender mejor su necesidad! Son 3 pasos r√°pidos.</p>
                </div>


                <div class="mt-6">
                    <div class="flex items-center gap-3">
                        <div class="flex-1 h-2 rounded-full bg-secondary" aria-hidden="true">
                            <div id="progressBar" class="h-2 rounded-full bg-primary transition-all duration-200" style="width: 33%"></div>
                        </div>
                        <span id="stepLabel" class="text-xs font-semibold text-muted-foreground">Paso 1 de 3</span>
                    </div>
                </div>
            </div>

            <form id="questionnaireForm" class="p-4 md:p-6 pt-0 space-y-6">
                <p class="text-xs text-muted-foreground italic">* Campos requeridos</p>
                <div id="step-1" class="space-y-4">
                    <h2 class="text-lg font-semibold text-foreground">1. ¬øQu√© opci√≥n le interesa?</h2>
                    <div class="grid md:grid-cols-3 gap-4">
                        <label id="creditoOption" class="block cursor-pointer group">
                            <input type="radio" name="interes" value="credito" id="creditoRadio" class="peer sr-only">
                            <div id="creditoCard" class="border rounded-lg p-4 h-full transition hover:shadow-md peer-checked:border-primary peer-checked:ring-2 peer-checked:ring-primary/20 bg-background">
                                <p class="text-sm font-semibold text-foreground">Cr√©dito</p>
                                <p class="text-xs text-muted-foreground mt-1">Financie sus metas y obligaciones.</p>
                            </div>
                        </label>
                        <label class="block cursor-pointer group">
                            <input type="radio" name="interes" value="servicios_legales" class="peer sr-only">
                            <div class="border rounded-lg p-4 h-full transition hover:shadow-md peer-checked:border-primary peer-checked:ring-2 peer-checked:ring-primary/20 bg-background">
                                <p class="text-sm font-semibold text-foreground">Servicios legales</p>
                                <p class="text-xs text-muted-foreground mt-1">Divorcios, traspasos, sucesiones u otros.</p>
                            </div>
                        </label>
                        <label id="ambosOption" class="block cursor-pointer group">
                            <input type="radio" name="interes" value="ambos" id="ambosRadio" class="peer sr-only">
                            <div id="ambosCard" class="border rounded-lg p-4 h-full transition hover:shadow-md peer-checked:border-primary peer-checked:ring-2 peer-checked:ring-primary/20 bg-background">
                                <p class="text-sm font-semibold text-foreground">Ambos</p>
                                <p class="text-xs text-muted-foreground mt-1">Necesito cr√©dito y apoyo legal.</p>
                            </div>
                        </label>
                    </div>

                </div>

                <div id="step-2" class="space-y-4 hidden">
                    <h2 class="text-lg font-semibold text-foreground">2. Por favor detalle su necesidad</h2>

                    <div id="creditoFields" class="space-y-3 hidden">
                        <p class="text-sm font-semibold text-muted-foreground">Cr√©dito</p>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-foreground mb-1">Monto aproximado que desea solicitar *</label>
                                <select name="monto" class="w-full px-3 py-2 bg-background border border-input rounded-md text-sm">
                                    <option value="">Selecciona un rango</option>
                                    <option value="100k-300k">100 mil - 300 mil</option>
                                    <option value="300k-500k">300 mil - 500 mil</option>
                                    <option value="500k-690k">500 mil - 690 mil</option>
                                    <option value="690+">690 mil o m√°s</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-foreground mb-1">Uso del cr√©dito *</label>
                                <select name="uso_credito" class="w-full px-3 py-2 bg-background border border-input rounded-md text-sm">
                                    <option value="">Selecciona</option>
                                    <option value="consumo">Consumo / personales</option>
                                    <option value="consolidacion">Consolidaci√≥n de deudas</option>
                                    <option value="negocio">Negocio / capital de trabajo</option>
                                </select>
                            </div>
                        </div>
                        <div id="institucionWrapper">
                            <label class="block text-sm font-medium text-foreground mb-1">Instituci√≥n en la que labora *</label>
                            <div id="institucionContainer" class="relative">
                                <button type="button" id="institucionTrigger" class="w-full h-10 px-3 bg-background border border-input rounded-md text-sm text-left flex items-center justify-between">
                                    <span id="institucionLabel" class="truncate text-muted-foreground">Seleccione la instituci√≥n</span>
                                    <span class="text-xs text-muted-foreground">‚ñº</span>
                                </button>
                                <div id="institucionDropdown" class="hidden absolute z-20 mt-1 w-full rounded-md border bg-white shadow-lg">
                                    <div class="p-2 border-b">
                                        <input id="institucionSearch" type="text" placeholder="Buscar instituci√≥n" class="w-full px-2 py-1 text-sm border rounded-md" aria-label="Buscar instituci√≥n">
                                    </div>
                                    <div id="institucionList" class="max-h-40 overflow-y-auto"></div>
                                </div>
                                <input type="hidden" id="institucionValue" name="institucion" value="">
                            </div>
                        </div>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-foreground mb-1">Tiempo laborando</label>
                                <select name="antiguedad_laboral" class="w-full px-3 py-2 bg-background border border-input rounded-md text-sm">
                                    <option value="">Seleccione</option>
                                    <option value="<1a">Menos de 1 a√±o</option>
                                    <option value="1-3a">1 a 3 a√±os</option>
                                    <option value="3-5a">3 a 5 a√±os</option>
                                    <option value=">5a">M√°s de 5 a√±os</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-foreground mb-1">Salario L√≠quido *</label>
                                <input type="text" name="salario_exacto" id="salarioExacto" placeholder="Ej: ‚Ç°450,000" class="w-full px-3 py-2 bg-background border border-input rounded-md text-sm">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-foreground mb-1">¬øTiene deudas actualmente? *</label>
                            <select name="tiene_deudas" class="w-full px-3 py-2 bg-background border border-input rounded-md text-sm">
                                <option value="">Seleccione</option>
                                <option value="no">No</option>
                                <option value="si_1_2">S√≠, 1-2 cr√©ditos</option>
                                <option value="si_3_mas">S√≠, 3 o m√°s</option>
                            </select>
                        </div>
                    </div>

                    <div id="legalesFields" class="space-y-3 hidden">
                        <p class="text-sm font-semibold text-muted-foreground">Servicios legales</p>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-foreground mb-1">Tipo de tr√°mite *</label>
                                <div class="space-y-2 border rounded-md p-3 bg-background">
                                    <label class="flex items-center gap-2 text-sm text-foreground">
                                        <input type="checkbox" name="tramites" value="divorcio" class="h-4 w-4 text-primary border-input rounded">
                                        <span>Divorcio</span>
                                    </label>
                                    <label class="flex items-center gap-2 text-sm text-foreground">
                                        <input type="checkbox" name="tramites" value="traspaso" class="h-4 w-4 text-primary border-input rounded">
                                        <span>Traspaso de bienes</span>
                                    </label>
                                    <label class="flex items-center gap-2 text-sm text-foreground">
                                        <input type="checkbox" name="tramites" value="testamentos" class="h-4 w-4 text-primary border-input rounded">
                                        <span>Testamentos</span>
                                    </label>
                                    <label class="flex items-center gap-2 text-sm text-foreground">
                                        <input type="checkbox" name="tramites" value="otros" class="h-4 w-4 text-primary border-input rounded">
                                        <span>Otros</span>
                                    </label>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-foreground mb-1">Urgencia *</label>
                                <select name="urgencia" class="w-full px-3 py-2 bg-background border border-input rounded-md text-sm">
                                    <option value="">Selecciona</option>
                                    <option value="inmediata">Inmediata (menos de 15 d√≠as)</option>
                                    <option value="30-60">En 30 - 60 d√≠as</option>
                                    <option value=">60">En m√°s de 60 d√≠as</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-foreground mb-1">Breve descripci√≥n</label>
                            <textarea name="detalle_legal" rows="3" class="w-full px-3 py-2 bg-background border border-input rounded-md text-sm" placeholder="Cu√©ntanos el contexto del tr√°mite"></textarea>
                        </div>
                    </div>
                </div>

                <div id="step-3" class="space-y-4 hidden">
                    <h2 class="text-lg font-semibold text-foreground">3. Perfil financiero</h2>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-foreground mb-1">Tipo de vivienda *</label>
                            <select name="tipo_vivienda" class="w-full px-3 py-2 bg-background border border-input rounded-md text-sm">
                                <option value="">Selecciona</option>
                                <option value="propia_pagada">Propia (pagada)</option>
                                <option value="propia_hipotecada">Propia (con hipoteca)</option>
                                <option value="alquilada">Alquilada</option>
                                <option value="familiar">Familiar / Prestada</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-foreground mb-1">Personas a tu cargo *</label>
                            <select name="dependientes" class="w-full px-3 py-2 bg-background border border-input rounded-md text-sm">
                                <option value="">Selecciona</option>
                                <option value="0">Ninguna</option>
                                <option value="1-2">1 - 2 personas</option>
                                <option value="3-4">3 - 4 personas</option>
                                <option value=">4">M√°s de 4 personas</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-foreground mb-1">Estado civil *</label>
                            <select name="estado_civil" class="w-full px-3 py-2 bg-background border border-input rounded-md text-sm">
                                <option value="">Selecciona</option>
                                <option value="Soltero(a)">Soltero(a)</option>
                                <option value="Casado(a)">Casado(a)</option>
                                <option value="Uni√≥n Libre">Uni√≥n Libre</option>
                                <option value="Divorciado(a)">Divorciado(a)</option>
                                <option value="Viudo(a)">Viudo(a)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-foreground mb-1">Nivel acad√©mico *</label>
                            <select name="nivel_academico" class="w-full px-3 py-2 bg-background border border-input rounded-md text-sm">
                                <option value="">Selecciona</option>
                                <option value="primaria">Primaria</option>
                                <option value="secundaria">Secundaria</option>
                                <option value="tecnico">T√©cnico / Vocacional</option>
                                <option value="universitario">Universitario</option>
                                <option value="posgrado">Posgrado</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-foreground mb-1">¬øC√≥mo conoci√≥ Credipep?</label>
                        <select name="origen_lead" class="w-full px-3 py-2 bg-background border border-input rounded-md text-sm">
                            <option value="">Selecciona</option>
                            <option value="redes_sociales">Redes sociales</option>
                            <option value="recomendacion">Recomendaci√≥n</option>
                            <option value="google">B√∫squeda en Google</option>
                            <option value="publicidad">Publicidad</option>
                            <option value="otro">Otro</option>
                        </select>
                    </div>
                    <div class="mt-4 p-3 bg-muted/50 rounded-md border border-muted">
                        <p class="text-xs text-muted-foreground">
                            üîí Tu informaci√≥n est√° segura y protegida. Cumplimos con la Ley de Protecci√≥n de Datos Personales y toda la informaci√≥n ser√° tratada de forma confidencial.
                        </p>
                    </div>
                </div>

                <div class="flex items-center justify-between pt-2">
                    <button type="button" id="backBtn" class="inline-flex items-center gap-2 rounded-md border px-4 py-2 text-sm font-medium text-foreground bg-background hover:bg-accent disabled:opacity-50" disabled>Atr√°s</button>
                    <div class="flex items-center gap-2">
                        <button type="button" id="nextBtn" class="inline-flex items-center justify-center rounded-md text-sm font-medium bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2">Siguiente</button>
                        <button type="submit" id="submitBtn" class="hidden inline-flex items-center justify-center rounded-md text-sm font-medium bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2">Enviar</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Di√°logo de salario bajo - bloquear cr√©dito -->
    <div id="salarioBajoDialog" class="hidden fixed inset-0 z-50 flex items-center justify-center">
        <div class="fixed inset-0 bg-black/50"></div>
        <div class="relative bg-card rounded-xl shadow-2xl p-6 md:p-8 max-w-md mx-4 text-center" style="animation: fadeIn 0.2s ease-out;">
            <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-8 h-8 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
            </div>
            <h2 class="text-xl font-headline font-bold text-foreground mb-2">Informaci√≥n Importante</h2>
            <p class="text-muted-foreground mb-6">Lamentamos informarte que actualmente no contamos con cr√©ditos para clientes del sector p√∫blico cuyo salario sea menor a ‚Ç°300,000. Sin embargo, puedes optar por nuestros <strong>cr√©ditos para servicios legales</strong> (divorcios, notariado, testamentos, etc.).</p>
            <button onclick="closeSalarioBajoDialog()" class="w-full inline-flex items-center justify-center rounded-md text-sm font-medium bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2">Entendido</button>
        </div>
    </div>

    <div id="successDialog" class="hidden fixed inset-0 z-50 flex items-center justify-center">
        <div class="fixed inset-0 bg-black/50" onclick="closeSuccessDialog()"></div>
        <div class="relative bg-card rounded-xl shadow-2xl p-6 md:p-8 max-w-md mx-4 text-center" style="animation: fadeIn 0.2s ease-out;">
            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
            </div>
            <h2 class="text-xl font-headline font-bold text-foreground mb-2">Listo</h2>
            <p class="text-muted-foreground mb-6">¬°Pronto un asesor de Credipep te escribir√° para ayudarte!</p>
            <button onclick="closeSuccessDialog()" class="w-full inline-flex items-center justify-center rounded-md text-sm font-medium bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2">Entendido</button>
        </div>
    </div>

    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
    </style>

    <script>
        const API_BASE_URL = window.location.origin;
        const steps = ['step-1', 'step-2', 'step-3'];
        let currentStep = 0;

        function showStep(index) {
            steps.forEach((id, i) => {
                const el = document.getElementById(id);
                if (!el) return;
                el.classList.toggle('hidden', i !== index);
            });
            document.getElementById('backBtn').disabled = index === 0;
            document.getElementById('nextBtn').classList.toggle('hidden', index === steps.length - 1);
            document.getElementById('submitBtn').classList.toggle('hidden', index !== steps.length - 1);
            const percent = ((index + 1) / steps.length) * 100;
            document.getElementById('progressBar').style.width = `${percent}%`;
            document.getElementById('stepLabel').textContent = `Paso ${index + 1} de ${steps.length}`;
        }

        function showAlert(message, type = 'error') {
            const alert = document.getElementById('alert');
            alert.textContent = message;
            alert.className = `p-4 mb-4 text-sm rounded-lg ${type === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`;
            alert.classList.remove('hidden');
            if (type === 'success') {
                setTimeout(() => alert.classList.add('hidden'), 4000);
            }
        }

        function clearAlert() {
            document.getElementById('alert').classList.add('hidden');
        }

        // Determinar tipo de cr√©dito basado en el monto seleccionado
        function determinarTipoCredito(montoValue) {
            return montoValue === '690+' ? 'regular' : 'microcredito';
        }

        function formatColones(value) {
            const num = value.replace(/[^0-9]/g, '');
            if (!num) return '';
            return '‚Ç°' + parseInt(num).toLocaleString('es-CR');
        }

        function getRawNumber(value) {
            return value.replace(/[^0-9]/g, '');
        }

        function updateDynamicBlocks() {
            const interes = document.querySelector('input[name="interes"]:checked')?.value;
            const showCredito = interes === 'credito' || interes === 'ambos';
            const showLegales = interes === 'servicios_legales' || interes === 'ambos';
            document.getElementById('creditoFields').classList.toggle('hidden', !showCredito);
            document.getElementById('legalesFields').classList.toggle('hidden', !showLegales);

        }

        // --- Instituciones Dropdown ---
        let institucionOptions = [];

        async function loadInstituciones() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/instituciones?activas_only=true`);
                if (response.ok) {
                    const data = await response.json();
                    institucionOptions = data.map(inst => inst.nombre);
                    renderInstitucionOptions();
                }
            } catch (error) {
                console.error('Error loading instituciones:', error);
            }
        }

        function renderInstitucionOptions(filter = '') {
            const list = document.getElementById('institucionList');
            if (!list) return;
            list.innerHTML = '';
            const term = filter.trim().toLowerCase();
            institucionOptions.forEach(name => {
                if (term && !name.toLowerCase().includes(term)) return;
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.textContent = name;
                btn.className = 'w-full text-left px-3 py-2 text-sm hover:bg-gray-100';
                btn.addEventListener('click', () => selectInstitucion(name));
                list.appendChild(btn);
            });
            if (!list.children.length) {
                const empty = document.createElement('div');
                empty.className = 'px-3 py-2 text-sm text-muted-foreground';
                empty.textContent = 'Sin resultados';
                list.appendChild(empty);
            }
        }

        function selectInstitucion(name) {
            const hidden = document.getElementById('institucionValue');
            const label = document.getElementById('institucionLabel');
            hidden.value = name || '';
            label.textContent = name || 'Seleccione instituci√≥n';
            label.classList.toggle('text-muted-foreground', !name);
            closeInstitucionDropdown();
        }

        function openInstitucionDropdown() {
            document.getElementById('institucionDropdown').classList.remove('hidden');
            renderInstitucionOptions(document.getElementById('institucionSearch').value || '');
            document.getElementById('institucionSearch').focus();
        }

        function closeInstitucionDropdown() {
            document.getElementById('institucionDropdown').classList.add('hidden');
        }

        function toggleInstitucionDropdown() {
            const dropdown = document.getElementById('institucionDropdown');
            if (dropdown.classList.contains('hidden')) {
                openInstitucionDropdown();
            } else {
                closeInstitucionDropdown();
            }
        }

        function validateStep(index) {
            clearAlert();
            if (index === 0) {
                const interes = document.querySelector('input[name="interes"]:checked');
                if (!interes) {
                    showAlert('Selecciona qu√© te interesa para continuar.');
                    return false;
                }
            }
            if (index === 1) {
                const interes = document.querySelector('input[name="interes"]:checked')?.value;
                if (interes === 'credito' || interes === 'ambos') {
                    const monto = document.querySelector('select[name="monto"]').value;
                    const uso = document.querySelector('select[name="uso_credito"]').value;
                    const institucion = document.getElementById('institucionValue').value;
                    const salario = getRawNumber(document.getElementById('salarioExacto').value);
                    const tieneDeudas = document.querySelector('select[name="tiene_deudas"]').value;

                    if (!monto || !uso || !institucion || !salario || !tieneDeudas) {
                        showAlert('Completa todos los datos de cr√©dito.');
                        return false;
                    }
                }
                if (interes === 'servicios_legales' || interes === 'ambos') {
                    const tramites = Array.from(document.querySelectorAll('input[name="tramites"]:checked'));
                    const urgencia = document.querySelector('select[name="urgencia"]').value;
                    if (tramites.length === 0 || !urgencia) {
                        showAlert('Selecciona al menos un tr√°mite legal y la urgencia.');
                        return false;
                    }
                }
            }
            if (index === 2) {
                const vivienda = document.querySelector('select[name="tipo_vivienda"]').value;
                const dependientes = document.querySelector('select[name="dependientes"]').value;
                const estadoCivil = document.querySelector('select[name="estado_civil"]').value;
                const nivelAcademico = document.querySelector('select[name="nivel_academico"]').value;
                if (!vivienda || !dependientes || !estadoCivil || !nivelAcademico) {
                    showAlert('Completa todos los campos obligatorios del perfil financiero.');
                    return false;
                }
            }
            return true;
        }

        function collectData() {
            const interes = document.querySelector('input[name="interes"]:checked')?.value || '';
            const data = { interes };
            if (interes === 'credito' || interes === 'ambos') {
                const montoValue = document.querySelector('select[name="monto"]').value;
                // Determinar autom√°ticamente el tipo de cr√©dito basado en el monto
                data.tipo_credito = determinarTipoCredito(montoValue);
                data.monto = montoValue;
                data.uso_credito = document.querySelector('select[name="uso_credito"]').value;
                data.institucion_labora = document.getElementById('institucionValue').value;
                data.salario_exacto = getRawNumber(document.getElementById('salarioExacto').value);
                data.tiene_deudas = document.querySelector('select[name="tiene_deudas"]').value;
            }
            if (interes === 'servicios_legales' || interes === 'ambos') {
                data.tramites = Array.from(document.querySelectorAll('input[name="tramites"]:checked')).map(el => el.value);
                data.urgencia = document.querySelector('select[name="urgencia"]').value;
                data.detalle_legal = document.querySelector('textarea[name="detalle_legal"]').value;
            }
            data.tipo_vivienda = document.querySelector('select[name="tipo_vivienda"]').value;
            data.dependientes = document.querySelector('select[name="dependientes"]').value;
            data.estado_civil = document.querySelector('select[name="estado_civil"]').value;
            data.nivel_academico = document.querySelector('select[name="nivel_academico"]').value;
            data.origen_lead = document.querySelector('select[name="origen_lead"]').value;
            return data;
        }

        function showSuccessDialog(message, elegibleCredito) {
            const dialog = document.getElementById('successDialog');
            const dialogContent = dialog.querySelector('.relative.bg-card');

            const iconBg = elegibleCredito ? 'bg-green-100' : 'bg-yellow-100';
            const iconColor = elegibleCredito ? 'text-green-600' : 'text-yellow-600';
            const title = elegibleCredito ? '¬°Listo!' : 'Informaci√≥n Importante';

            dialogContent.innerHTML = `
                <div class="w-16 h-16 ${iconBg} rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 ${iconColor}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        ${elegibleCredito
                            ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>'
                            : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>'
                        }
                    </svg>
                </div>
                <h2 class="text-xl font-headline font-bold text-foreground mb-2">${title}</h2>
                <p class="text-muted-foreground mb-6">${message}</p>
                <button onclick="window.location.reload()" class="w-full inline-flex items-center justify-center rounded-md text-sm font-medium bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2">Entendido</button>
            `;

            dialog.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeSuccessDialog() {
            document.getElementById('successDialog').classList.add('hidden');
            document.body.style.overflow = '';
        }

        // Variable para rastrear si cr√©dito est√° bloqueado
        let creditoBloqueado = false;

        // Obtener clave √∫nica para localStorage basada en la c√©dula
        function getStorageKey() {
            const urlParams = new URLSearchParams(window.location.search);
            const cedulaHash = Array.from(urlParams.keys())[0] || 'default';
            return `creditoBloqueado_${cedulaHash}`;
        }

        // Verificar si el cr√©dito est√° bloqueado en localStorage
        function checkCreditoBloqueadoStorage() {
            const key = getStorageKey();
            const bloqueado = localStorage.getItem(key);
            if (bloqueado === 'true') {
                bloquearCredito(false); // false = no guardar de nuevo en localStorage
            }
        }

        function showSalarioBajoDialog() {
            document.getElementById('salarioBajoDialog').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeSalarioBajoDialog() {
            document.getElementById('salarioBajoDialog').classList.add('hidden');
            document.body.style.overflow = '';

            // Bloquear opci√≥n de cr√©dito (y guardar en localStorage)
            bloquearCredito(true);

            // Volver al paso 1
            currentStep = 0;
            showStep(currentStep);

            // Limpiar selecci√≥n de inter√©s
            document.querySelectorAll('input[name="interes"]').forEach(input => {
                input.checked = false;
            });
        }

        function bloquearCredito(guardarEnStorage = true) {
            creditoBloqueado = true;

            // Guardar en localStorage para persistir despu√©s de recargar
            if (guardarEnStorage) {
                const key = getStorageKey();
                localStorage.setItem(key, 'true');
            }

            // Bloquear opci√≥n Cr√©dito
            const creditoOption = document.getElementById('creditoOption');
            const creditoRadio = document.getElementById('creditoRadio');
            const creditoCard = document.getElementById('creditoCard');

            creditoRadio.disabled = true;
            creditoOption.classList.remove('cursor-pointer');
            creditoOption.classList.add('cursor-not-allowed', 'opacity-50');
            creditoCard.classList.add('bg-gray-100');
            creditoCard.classList.remove('hover:shadow-md');

            if (!document.getElementById('creditoBloqueadoMsg')) {
                const msg = document.createElement('p');
                msg.id = 'creditoBloqueadoMsg';
                msg.className = 'text-xs text-red-500 mt-1';
                msg.textContent = 'No disponible para tu rango salarial';
                creditoCard.appendChild(msg);
            }

            // Bloquear opci√≥n Ambos
            const ambosOption = document.getElementById('ambosOption');
            const ambosRadio = document.getElementById('ambosRadio');
            const ambosCard = document.getElementById('ambosCard');

            ambosRadio.disabled = true;
            ambosOption.classList.remove('cursor-pointer');
            ambosOption.classList.add('cursor-not-allowed', 'opacity-50');
            ambosCard.classList.add('bg-gray-100');
            ambosCard.classList.remove('hover:shadow-md');

            if (!document.getElementById('ambosBloqueadoMsg')) {
                const msg = document.createElement('p');
                msg.id = 'ambosBloqueadoMsg';
                msg.className = 'text-xs text-red-500 mt-1';
                msg.textContent = 'No disponible para tu rango salarial';
                ambosCard.appendChild(msg);
            }
        }

        function checkSalarioBajo() {
            const salarioExacto = document.getElementById('salarioExacto');
            const interes = document.querySelector('input[name="interes"]:checked')?.value;

            // Obtener valor num√©rico del salario
            const salarioValue = parseInt(getRawNumber(salarioExacto.value));

            // Solo verificar si el inter√©s incluye cr√©dito y el salario es menor a 300,000
            if ((interes === 'credito' || interes === 'ambos') && salarioValue < 300000) {
                showSalarioBajoDialog();
                return true;
            }
            return false;
        }

        async function checkQuestionnaireStatus() {
            // Obtener c√©dula de la URL
            const urlParams = new URLSearchParams(window.location.search);
            const cedulaHash = Array.from(urlParams.keys())[0];

            if (!cedulaHash) {
                showAlert('No se proporcion√≥ identificaci√≥n v√°lida.', 'error');
                document.getElementById('questionnaireForm').innerHTML = '<p class="text-center text-red-600">Enlace inv√°lido</p>';
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/api/questionnaire/status?cedula=${encodeURIComponent(cedulaHash)}`);
                const data = await response.json();

                if (data.completed) {
                    // Ocultar header y formulario, mostrar solo mensaje
                    const header = document.getElementById('questionnaireHeader');
                    if (header) header.style.display = 'none';
                    document.getElementById('questionnaireForm').innerHTML = `
                        <div class="text-center p-8">
                            <svg class="mx-auto h-16 w-16 text-green-500 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <h2 class="text-2xl font-bold text-foreground mb-2">Cuestionario ya completado</h2>
                            <p class="text-muted-foreground mb-4">Este cuestionario fue completado el ${new Date(data.completed_at).toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
                            <p class="text-sm text-muted-foreground">Si necesitas actualizar tu informaci√≥n, por favor contacta a nuestro equipo.</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error verificando estado del cuestionario:', error);
                // Si hay error, dejar que contin√∫e normalmente
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Verificar si el cuestionario ya fue completado
            checkQuestionnaireStatus();

            // Verificar si el cr√©dito est√° bloqueado (persistido en localStorage)
            checkCreditoBloqueadoStorage();

            showStep(currentStep);
            document.querySelectorAll('input[name="interes"]').forEach(input => {
                input.addEventListener('change', (e) => {
                    // Si cr√©dito est√° bloqueado y selecciona cr√©dito o ambos, prevenir
                    if (creditoBloqueado && (e.target.value === 'credito' || e.target.value === 'ambos')) {
                        e.preventDefault();
                        e.target.checked = false;
                        showAlert('La opci√≥n de cr√©dito no est√° disponible para tu rango salarial. Por favor selecciona Servicios Legales.');
                        return;
                    }
                    updateDynamicBlocks();
                });
            });
            // Salario - formatear y validar
            const salarioInput = document.getElementById('salarioExacto');
            salarioInput.addEventListener('input', (e) => {
                const raw = getRawNumber(e.target.value);
                e.target.value = raw ? formatColones(raw) : '';
            });
            salarioInput.addEventListener('blur', () => {
                checkSalarioBajo();
            });
            // Instituci√≥n dropdown event listeners
            loadInstituciones();
            document.getElementById('institucionTrigger').addEventListener('click', (e) => {
                e.stopPropagation();
                toggleInstitucionDropdown();
            });
            document.getElementById('institucionSearch').addEventListener('input', (e) => {
                renderInstitucionOptions(e.target.value || '');
            });

            document.addEventListener('click', (e) => {
                // Cerrar institucion dropdown
                const institucionDropdown = document.getElementById('institucionDropdown');
                const institucionContainer = document.getElementById('institucionContainer');
                if (institucionContainer && !institucionContainer.contains(e.target)) {
                    institucionDropdown.classList.add('hidden');
                }
            });
            document.getElementById('backBtn').addEventListener('click', () => {
                if (currentStep > 0) {
                    currentStep -= 1;
                    showStep(currentStep);
                }
            });
            document.getElementById('nextBtn').addEventListener('click', () => {
                if (!validateStep(currentStep)) return;
                if (currentStep < steps.length - 1) {
                    currentStep += 1;
                    showStep(currentStep);
                }
            });

            document.getElementById('questionnaireForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!validateStep(2)) return;

                // Collect form data
                const data = collectData();
                const formData = new FormData();

                // Add all questionnaire data as JSON
                formData.append('questionnaire_data', JSON.stringify(data));

                // Get cedula from URL (base64 encoded)
                const urlParams = new URLSearchParams(window.location.search);
                const cedulaHash = Array.from(urlParams.keys())[0];
                if (cedulaHash) {
                    try {
                        const cedula = atob(cedulaHash);
                        formData.append('cedula', cedula);
                    } catch (e) {
                        console.error('Error decoding cedula from URL');
                    }
                }

                // Submit to API
                try {
                    showAlert('Enviando informaci√≥n...', 'success');
                    const response = await fetch(`${API_BASE_URL}/api/questionnaire/submit`, {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        const result = await response.json();
                        showSuccessDialog(result.message, result.elegible_credito);
                    } else {
                        const error = await response.json();
                        showAlert(error.message || 'Error al enviar el formulario.', 'error');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    showAlert('Error de conexi√≥n. Intenta nuevamente.', 'error');
                }
            });
        });
    </script>
</body>
</html>
