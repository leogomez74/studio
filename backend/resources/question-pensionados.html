<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cuestionario Pensionados</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --background: 220 13% 97%;
            --foreground: 224 71.4% 4.1%;
            --card: 0 0% 100%;
            --card-foreground: 224 71.4% 4.1%;
            --primary: 209 78% 34%;
            --primary-foreground: 0 0% 100%;
            --secondary: 220 13% 91%;
            --secondary-foreground: 220 9% 38%;
            --muted: 220 13% 91%;
            --muted-foreground: 220 9% 45%;
            --accent: 220 14% 96%;
            --border: 220 13% 85%;
            --input: 220 13% 85%;
            --ring: 209 78% 34%;
            --radius: 0.5rem;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: hsl(var(--background));
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        headline: ['Space Grotesk', 'sans-serif'],
                    },
                    colors: {
                        background: 'hsl(var(--background))',
                        foreground: 'hsl(var(--foreground))',
                        card: 'hsl(var(--card))',
                        'card-foreground': 'hsl(var(--card-foreground))',
                        primary: 'hsl(var(--primary))',
                        'primary-foreground': 'hsl(var(--primary-foreground))',
                        secondary: 'hsl(var(--secondary))',
                        'secondary-foreground': 'hsl(var(--secondary-foreground))',
                        muted: 'hsl(var(--muted))',
                        'muted-foreground': 'hsl(var(--muted-foreground))',
                        accent: 'hsl(var(--accent))',
                        border: 'hsl(var(--border))',
                        input: 'hsl(var(--input))',
                        ring: 'hsl(var(--ring))',
                    },
                    borderRadius: {
                        lg: 'var(--radius)',
                        md: 'calc(var(--radius) - 2px)',
                        sm: 'calc(var(--radius) - 4px)',
                    }
                }
            }
        }
    </script>
</head>
<body class="min-h-screen flex items-center justify-center p-2 md:p-4">
    <div class="w-full max-w-3xl">
        <div id="alert" class="hidden p-4 mb-4 text-sm rounded-lg" role="alert"></div>

        <div class="bg-card text-card-foreground rounded-xl border shadow-lg">
            <div class="p-4 md:p-6">
                <div class="text-center space-y-1">
                    <p class="text-xs font-semibold tracking-wide text-primary uppercase">Pensionados</p>
                    <h1 class="text-2xl md:text-3xl font-headline font-bold text-primary">Cuestionario Pensionados</h1>
                    <p class="text-muted-foreground text-sm md:text-base">Financia tus trámites o necesidades con tu pensión como respaldo. 4 pasos rápidos.</p>
                </div>

                <div class="mt-6">
                    <div class="flex items-center gap-3">
                        <div class="flex-1 h-2 rounded-full bg-secondary" aria-hidden="true">
                            <div id="progressBar" class="h-2 rounded-full bg-primary transition-all duration-200" style="width: 33%"></div>
                        </div>
                        <span id="stepLabel" class="text-xs font-semibold text-muted-foreground">Paso 1 de 3</span>
                    </div>
                </div>
            </div>

            <form id="questionnaireForm" class="p-4 md:p-6 pt-0 space-y-6">
                <div id="step-1" class="space-y-4">
                    <h2 class="text-lg font-semibold text-foreground">1. Perfil de pensión</h2>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-foreground mb-1">¿Quién paga tu pensión? *</label>
                            <select name="entidad" class="w-full px-3 py-2 bg-background border border-input rounded-md text-sm">
                                <option value="">Selecciona</option>
                                <option value="hacienda">Ministerio de Hacienda</option>
                                <option value="poder_judicial">Poder Judicial</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-foreground mb-1">Antigüedad recibiendo pensión *</label>
                            <select name="antiguedad" class="w-full px-3 py-2 bg-background border border-input rounded-md text-sm">
                                <option value="">Selecciona</option>
                                <option value="<1a">Menos de 1 año</option>
                                <option value="1-3a">1 - 3 años</option>
                                <option value=">3a">Más de 3 años</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-foreground mb-1">Monto mensual de pensión (neto) *</label>
                            <input type="number" name="pension_neta" class="w-full px-3 py-2 bg-background border border-input rounded-md text-sm" placeholder="Ej: 450000" min="0">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-foreground mb-1">Rango de edad *</label>
                            <select name="rango_edad" class="w-full px-3 py-2 bg-background border border-input rounded-md text-sm">
                                <option value="">Selecciona</option>
                                <option value="45-55">45 - 55 años</option>
                                <option value="56-65">56 - 65 años</option>
                                <option value="66-75">66 - 75 años</option>
                                <option value=">75">Más de 75 años</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-foreground mb-1">¿Tienes otras deudas? *</label>
                            <select name="tiene_deudas" class="w-full px-3 py-2 bg-background border border-input rounded-md text-sm">
                                <option value="">Selecciona</option>
                                <option value="no">No</option>
                                <option value="si_1_2">Sí, 1-2 créditos</option>
                                <option value="si_3_mas">Sí, 3 o más</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-foreground mb-1">Estado civil</label>
                            <select name="estado_civil" class="w-full px-3 py-2 bg-background border border-input rounded-md text-sm">
                                <option value="">Selecciona</option>
                                <option value="soltero">Soltero/a</option>
                                <option value="casado">Casado/a</option>
                                <option value="union_libre">Unión libre</option>
                                <option value="viudo">Viudo/a</option>
                                <option value="divorciado">Divorciado/a</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div id="step-2" class="space-y-4 hidden">
                    <h2 class="text-lg font-semibold text-foreground">2. Detalles del crédito</h2>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-foreground mb-1">Monto requerido *</label>
                            <select name="monto" class="w-full px-3 py-2 bg-background border border-input rounded-md text-sm">
                                <option value="">Selecciona un rango</option>
                                <option value="100k-300k">100 mil - 300 mil</option>
                                <option value="300k-500k">300 mil - 500 mil</option>
                                <option value="500k-690k">500 mil - 690 mil</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-foreground mb-1">Plazo preferido *</label>
                            <select name="plazo" class="w-full px-3 py-2 bg-background border border-input rounded-md text-sm">
                                <option value="">Selecciona</option>
                                <option value="12">12 meses</option>
                                <option value="24">24 meses</option>
                                <option value="36">36 meses</option>
                                <option value=">48">48 meses o más</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-foreground mb-1">Destino del crédito *</label>
                            <select name="destino" class="w-full px-3 py-2 bg-background border border-input rounded-md text-sm">
                                <option value="">Selecciona</option>
                                <option value="consumo">Consumo / personales</option>
                                <option value="consolidacion">Consolidación de deudas</option>
                                <option value="salud">Salud</option>
                                <option value="otro">Otro</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-foreground mb-1">Deducciones mensuales actuales</label>
                            <input type="number" name="deducciones" class="w-full px-3 py-2 bg-background border border-input rounded-md text-sm" placeholder="Ej: 120000" min="0">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-foreground mb-1">Breve contexto (opcional)</label>
                        <textarea name="detalle" rows="3" class="w-full px-3 py-2 bg-background border border-input rounded-md text-sm" placeholder="Ej: consolidar deudas, cubrir tratamientos, gastos personales, etc."></textarea>
                    </div>
                </div>

                <div id="step-3" class="space-y-4 hidden">
                    <h2 class="text-lg font-semibold text-foreground">3. Perfil financiero</h2>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-foreground mb-1">¿Has tenido créditos antes? *</label>
                            <select name="experiencia_crediticia" class="w-full px-3 py-2 bg-background border border-input rounded-md text-sm">
                                <option value="">Selecciona</option>
                                <option value="si_bancarios">Sí, con bancos</option>
                                <option value="si_cooperativas">Sí, con cooperativas</option>
                                <option value="si_otros">Sí, con otras entidades</option>
                                <option value="no">No, es mi primer crédito</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-foreground mb-1">Historial de pagos *</label>
                            <select name="historial_mora" class="w-full px-3 py-2 bg-background border border-input rounded-md text-sm">
                                <option value="">Selecciona</option>
                                <option value="siempre_al_dia">Siempre al día</option>
                                <option value="atrasos_ocasionales">Atrasos ocasionales (1-2 veces)</option>
                                <option value="atrasos_frecuentes">Atrasos frecuentes</option>
                                <option value="no_aplica">No aplica / Primer crédito</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-foreground mb-1">Tipo de vivienda *</label>
                            <select name="tipo_vivienda" class="w-full px-3 py-2 bg-background border border-input rounded-md text-sm">
                                <option value="">Selecciona</option>
                                <option value="propia_pagada">Propia (pagada)</option>
                                <option value="propia_hipotecada">Propia (con hipoteca)</option>
                                <option value="alquilada">Alquilada</option>
                                <option value="familiar">Familiar / Prestada</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-foreground mb-1">Personas a tu cargo *</label>
                            <select name="dependientes" class="w-full px-3 py-2 bg-background border border-input rounded-md text-sm">
                                <option value="">Selecciona</option>
                                <option value="0">Ninguna</option>
                                <option value="1-2">1 - 2 personas</option>
                                <option value="3-4">3 - 4 personas</option>
                                <option value=">4">Más de 4 personas</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-foreground mb-1">¿Cómo conociste Credipep?</label>
                        <select name="origen_lead" class="w-full px-3 py-2 bg-background border border-input rounded-md text-sm">
                            <option value="">Selecciona</option>
                            <option value="redes_sociales">Redes sociales</option>
                            <option value="recomendacion">Recomendación</option>
                            <option value="google">Búsqueda en Google</option>
                            <option value="publicidad">Publicidad</option>
                            <option value="otro">Otro</option>
                        </select>
                    </div>
                </div>

                <div id="step-4" class="space-y-4 hidden">
                    <h2 class="text-lg font-semibold text-foreground">4. Documentos requeridos</h2>
                    <p class="text-sm text-muted-foreground">Para completar tu solicitud, por favor adjunta los siguientes documentos.</p>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-foreground mb-2">Cédula de identidad (imagen) *</label>
                            <div class="border-2 border-dashed border-border rounded-lg p-6 text-center hover:border-primary transition-colors cursor-pointer" id="cedulaDropZone">
                                <input type="file" id="cedulaFile" name="cedula_file" accept="image/*" class="hidden" required>
                                <div id="cedulaPlaceholder">
                                    <svg class="w-12 h-12 mx-auto text-muted-foreground mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                    </svg>
                                    <p class="text-sm text-foreground font-medium">Click para seleccionar tu cédula</p>
                                    <p class="text-xs text-muted-foreground mt-1">o arrastra la imagen aquí</p>
                                    <p class="text-xs text-muted-foreground mt-1">PNG, JPG hasta 5MB</p>
                                </div>
                                <div id="cedulaPreview" class="hidden">
                                    <img id="cedulaImage" class="max-w-full h-auto rounded-md mx-auto" style="max-height: 200px;">
                                    <p id="cedulaFileName" class="text-sm text-foreground font-medium mt-2"></p>
                                    <button type="button" id="cedulaRemove" class="mt-2 text-xs text-red-600 hover:text-red-700 font-medium">Eliminar</button>
                                </div>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-foreground mb-2">Recibo de servicio (imagen o PDF) *</label>
                            <div class="border-2 border-dashed border-border rounded-lg p-6 text-center hover:border-primary transition-colors cursor-pointer" id="reciboDropZone">
                                <input type="file" id="reciboFile" name="recibo_file" accept="image/*,application/pdf" class="hidden" required>
                                <div id="reciboPlaceholder">
                                    <svg class="w-12 h-12 mx-auto text-muted-foreground mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                    <p class="text-sm text-foreground font-medium">Click para seleccionar tu recibo</p>
                                    <p class="text-xs text-muted-foreground mt-1">o arrastra el archivo aquí</p>
                                    <p class="text-xs text-muted-foreground mt-1">PNG, JPG, PDF hasta 5MB</p>
                                </div>
                                <div id="reciboPreview" class="hidden">
                                    <div id="reciboImageContainer" class="hidden">
                                        <img id="reciboImage" class="max-w-full h-auto rounded-md mx-auto" style="max-height: 200px;">
                                    </div>
                                    <div id="reciboPdfContainer" class="hidden">
                                        <svg class="w-16 h-16 mx-auto text-red-600 mb-2" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd"></path>
                                        </svg>
                                    </div>
                                    <p id="reciboFileName" class="text-sm text-foreground font-medium mt-2"></p>
                                    <button type="button" id="reciboRemove" class="mt-2 text-xs text-red-600 hover:text-red-700 font-medium">Eliminar</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-6 p-4 bg-accent/50 rounded-lg border border-border/50">
                        <div class="flex items-start gap-3">
                            <svg class="w-5 h-5 text-primary flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                            </svg>
                            <div class="flex-1">
                                <p class="text-sm font-semibold text-foreground mb-2">Protección de datos personales</p>
                                <p class="text-xs text-muted-foreground leading-relaxed">
                                    Los datos y documentos que nos proporcionas están protegidos bajo nuestra política de privacidad y la normativa de protección de datos personales.
                                    Serán utilizados exclusivamente para procesar tu solicitud de crédito o servicios legales. Tus archivos se almacenan de forma segura
                                    y solo el personal autorizado tendrá acceso a ellos. Al enviar este formulario, aceptas nuestros términos y condiciones.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex items-center justify-between pt-2">
                    <button type="button" id="backBtn" class="inline-flex items-center gap-2 rounded-md border px-4 py-2 text-sm font-medium text-foreground bg-background hover:bg-accent disabled:opacity-50" disabled>Atrás</button>
                    <div class="flex items-center gap-2">
                        <button type="button" id="nextBtn" class="inline-flex items-center justify-center rounded-md text-sm font-medium bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2">Siguiente</button>
                        <button type="submit" id="submitBtn" class="hidden inline-flex items-center justify-center rounded-md text-sm font-medium bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2">Enviar</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div id="successDialog" class="hidden fixed inset-0 z-50 flex items-center justify-center">
        <div class="fixed inset-0 bg-black/50" onclick="closeSuccessDialog()"></div>
        <div class="relative bg-card rounded-xl shadow-2xl p-6 md:p-8 max-w-md mx-4 text-center" style="animation: fadeIn 0.2s ease-out;">
            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
            </div>
            <h2 class="text-xl font-headline font-bold text-foreground mb-2">Listo</h2>
            <p class="text-muted-foreground mb-6">Guardamos tus respuestas para continuar el proceso. Pronto te contactaremos.</p>
            <button onclick="closeSuccessDialog()" class="w-full inline-flex items-center justify-center rounded-md text-sm font-medium bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2">Entendido</button>
        </div>
    </div>

    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
    </style>

    <script>
        const steps = ['step-1', 'step-2', 'step-3', 'step-4'];
        let currentStep = 0;

        function showStep(index) {
            steps.forEach((id, i) => {
                const el = document.getElementById(id);
                if (!el) return;
                el.classList.toggle('hidden', i !== index);
            });
            document.getElementById('backBtn').disabled = index === 0;
            document.getElementById('nextBtn').classList.toggle('hidden', index === steps.length - 1);
            document.getElementById('submitBtn').classList.toggle('hidden', index !== steps.length - 1);
            const percent = ((index + 1) / steps.length) * 100;
            document.getElementById('progressBar').style.width = `${percent}%`;
            document.getElementById('stepLabel').textContent = `Paso ${index + 1} de ${steps.length}`;
        }

        function showAlert(message, type = 'error') {
            const alert = document.getElementById('alert');
            alert.textContent = message;
            alert.className = `p-4 mb-4 text-sm rounded-lg ${type === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`;
            alert.classList.remove('hidden');
            if (type === 'success') {
                setTimeout(() => alert.classList.add('hidden'), 4000);
            }
        }

        function clearAlert() {
            document.getElementById('alert').classList.add('hidden');
        }

        function validateStep(index) {
            clearAlert();
            if (index === 0) {
                const entidad = document.querySelector('select[name="entidad"]').value;
                const antiguedad = document.querySelector('select[name="antiguedad"]').value;
                const pensionNeta = document.querySelector('input[name="pension_neta"]').value.trim();
                const rangoEdad = document.querySelector('select[name="rango_edad"]').value;
                const tieneDeudas = document.querySelector('select[name="tiene_deudas"]').value;
                if (!entidad || !antiguedad || !pensionNeta || !rangoEdad || !tieneDeudas) {
                    showAlert('Completa todos los campos del perfil de pensión.');
                    return false;
                }
                if (Number(pensionNeta) <= 0) {
                    showAlert('El monto de pensión debe ser mayor a cero.');
                    return false;
                }
            }
            if (index === 1) {
                const monto = document.querySelector('select[name="monto"]').value;
                const plazo = document.querySelector('select[name="plazo"]').value;
                const destino = document.querySelector('select[name="destino"]').value;
                if (!monto || !plazo || !destino) {
                    showAlert('Completa monto, plazo y destino del crédito.');
                    return false;
                }
            }
            if (index === 2) {
                const experiencia = document.querySelector('select[name="experiencia_crediticia"]').value;
                const historial = document.querySelector('select[name="historial_mora"]').value;
                const vivienda = document.querySelector('select[name="tipo_vivienda"]').value;
                const dependientes = document.querySelector('select[name="dependientes"]').value;
                if (!experiencia || !historial || !vivienda || !dependientes) {
                    showAlert('Completa todos los campos obligatorios del perfil financiero.');
                    return false;
                }
            }
            if (index === 3) {
                const cedulaFile = document.getElementById('cedulaFile').files[0];
                const reciboFile = document.getElementById('reciboFile').files[0];
                if (!cedulaFile) {
                    showAlert('Por favor adjunta una imagen de tu cédula.');
                    return false;
                }
                if (!reciboFile) {
                    showAlert('Por favor adjunta tu recibo de servicio.');
                    return false;
                }
                // Validate file sizes (max 5MB)
                if (cedulaFile.size > 5 * 1024 * 1024) {
                    showAlert('La imagen de la cédula no debe superar 5MB.');
                    return false;
                }
                if (reciboFile.size > 5 * 1024 * 1024) {
                    showAlert('El recibo no debe superar 5MB.');
                    return false;
                }
            }
            return true;
        }

        function collectData() {
            return {
                entidad: document.querySelector('select[name="entidad"]').value,
                antiguedad: document.querySelector('select[name="antiguedad"]').value,
                pension_neta: document.querySelector('input[name="pension_neta"]').value.trim(),
                rango_edad: document.querySelector('select[name="rango_edad"]').value,
                tiene_deudas: document.querySelector('select[name="tiene_deudas"]').value,
                estado_civil: document.querySelector('select[name="estado_civil"]').value,
                monto: document.querySelector('select[name="monto"]').value,
                plazo: document.querySelector('select[name="plazo"]').value,
                destino: document.querySelector('select[name="destino"]').value,
                deducciones: document.querySelector('input[name="deducciones"]').value.trim(),
                detalle: document.querySelector('textarea[name="detalle"]').value,
                experiencia_crediticia: document.querySelector('select[name="experiencia_crediticia"]').value,
                historial_mora: document.querySelector('select[name="historial_mora"]').value,
                tipo_vivienda: document.querySelector('select[name="tipo_vivienda"]').value,
                dependientes: document.querySelector('select[name="dependientes"]').value,
                origen_lead: document.querySelector('select[name="origen_lead"]').value,
            };
        }

        function showSuccessDialog() {
            document.getElementById('successDialog').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeSuccessDialog() {
            document.getElementById('successDialog').classList.add('hidden');
            document.body.style.overflow = '';
        }

        function setupFileUpload(fieldName, acceptTypes) {
            const fileInput = document.getElementById(`${fieldName}File`);
            const dropZone = document.getElementById(`${fieldName}DropZone`);
            const placeholder = document.getElementById(`${fieldName}Placeholder`);
            const preview = document.getElementById(`${fieldName}Preview`);
            const removeBtn = document.getElementById(`${fieldName}Remove`);
            const fileName = document.getElementById(`${fieldName}FileName`);

            // Click to upload
            dropZone.addEventListener('click', () => {
                if (!preview.classList.contains('hidden')) return;
                fileInput.click();
            });

            // File selected
            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    handleFile(file, fieldName);
                }
            });

            // Drag and drop
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('border-primary', 'bg-accent');
            });

            dropZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                dropZone.classList.remove('border-primary', 'bg-accent');
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('border-primary', 'bg-accent');
                const file = e.dataTransfer.files[0];
                if (file) {
                    // Validate file type
                    const acceptedTypes = acceptTypes.split(',').map(t => t.trim());
                    const fileType = file.type;
                    const isValid = acceptedTypes.some(type => {
                        if (type.includes('*')) {
                            const baseType = type.split('/')[0];
                            return fileType.startsWith(baseType);
                        }
                        return fileType === type;
                    });

                    if (!isValid) {
                        showAlert(`Tipo de archivo no válido para ${fieldName}.`, 'error');
                        return;
                    }

                    // Set the file to the input
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    fileInput.files = dataTransfer.files;

                    handleFile(file, fieldName);
                }
            });

            // Remove file
            removeBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                fileInput.value = '';
                placeholder.classList.remove('hidden');
                preview.classList.add('hidden');
                if (fieldName === 'cedula') {
                    document.getElementById('cedulaImage').src = '';
                } else if (fieldName === 'recibo') {
                    document.getElementById('reciboImageContainer').classList.add('hidden');
                    document.getElementById('reciboPdfContainer').classList.add('hidden');
                    document.getElementById('reciboImage').src = '';
                }
            });
        }

        function handleFile(file, fieldName) {
            const placeholder = document.getElementById(`${fieldName}Placeholder`);
            const preview = document.getElementById(`${fieldName}Preview`);
            const fileName = document.getElementById(`${fieldName}FileName`);

            // Show filename
            fileName.textContent = file.name;

            // Show preview
            placeholder.classList.add('hidden');
            preview.classList.remove('hidden');

            // Handle image preview
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    if (fieldName === 'cedula') {
                        document.getElementById('cedulaImage').src = e.target.result;
                    } else if (fieldName === 'recibo') {
                        document.getElementById('reciboImageContainer').classList.remove('hidden');
                        document.getElementById('reciboPdfContainer').classList.add('hidden');
                        document.getElementById('reciboImage').src = e.target.result;
                    }
                };
                reader.readAsDataURL(file);
            } else if (file.type === 'application/pdf' && fieldName === 'recibo') {
                // Show PDF icon
                document.getElementById('reciboImageContainer').classList.add('hidden');
                document.getElementById('reciboPdfContainer').classList.remove('hidden');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            showStep(currentStep);
            document.getElementById('backBtn').addEventListener('click', () => {
                if (currentStep > 0) {
                    currentStep -= 1;
                    showStep(currentStep);
                }
            });
            document.getElementById('nextBtn').addEventListener('click', () => {
                if (!validateStep(currentStep)) return;
                if (currentStep < steps.length - 1) {
                    currentStep += 1;
                    showStep(currentStep);
                }
            });

            // File upload handlers
            setupFileUpload('cedula', 'image/*');
            setupFileUpload('recibo', 'image/*,application/pdf');

            document.getElementById('questionnaireForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!validateStep(3)) return;

                // Collect form data
                const data = collectData();
                const formData = new FormData();

                // Add all questionnaire data as JSON
                formData.append('questionnaire_data', JSON.stringify(data));

                // Add files
                const cedulaFile = document.getElementById('cedulaFile').files[0];
                const reciboFile = document.getElementById('reciboFile').files[0];
                formData.append('cedula_file', cedulaFile);
                formData.append('recibo_file', reciboFile);

                // Get cedula from URL (base64 encoded)
                const urlParams = new URLSearchParams(window.location.search);
                const cedulaHash = Array.from(urlParams.keys())[0];
                if (cedulaHash) {
                    try {
                        const cedula = atob(cedulaHash);
                        formData.append('cedula', cedula);
                    } catch (e) {
                        console.error('Error decoding cedula from URL');
                    }
                }

                // Submit to API
                try {
                    showAlert('Enviando información...', 'success');
                    const response = await fetch('/api/questionnaire/submit', {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        showAlert('Respuestas guardadas. Pronto te contactaremos.', 'success');
                        showSuccessDialog();
                    } else {
                        const error = await response.json();
                        showAlert(error.message || 'Error al enviar el formulario.', 'error');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    showAlert('Error de conexión. Intenta nuevamente.', 'error');
                }
            });
        });
    </script>
</body>
</html>
