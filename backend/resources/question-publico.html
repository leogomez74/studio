<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cuestionario Público</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --background: 220 13% 97%;
            --foreground: 224 71.4% 4.1%;
            --card: 0 0% 100%;
            --card-foreground: 224 71.4% 4.1%;
            --primary: 209 78% 34%;
            --primary-foreground: 0 0% 100%;
            --secondary: 220 13% 91%;
            --secondary-foreground: 220 9% 38%;
            --muted: 220 13% 91%;
            --muted-foreground: 220 9% 45%;
            --accent: 220 14% 96%;
            --border: 220 13% 85%;
            --input: 220 13% 85%;
            --ring: 209 78% 34%;
            --radius: 0.5rem;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: hsl(var(--background));
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        headline: ['Space Grotesk', 'sans-serif'],
                    },
                    colors: {
                        background: 'hsl(var(--background))',
                        foreground: 'hsl(var(--foreground))',
                        card: 'hsl(var(--card))',
                        'card-foreground': 'hsl(var(--card-foreground))',
                        primary: 'hsl(var(--primary))',
                        'primary-foreground': 'hsl(var(--primary-foreground))',
                        secondary: 'hsl(var(--secondary))',
                        'secondary-foreground': 'hsl(var(--secondary-foreground))',
                        muted: 'hsl(var(--muted))',
                        'muted-foreground': 'hsl(var(--muted-foreground))',
                        accent: 'hsl(var(--accent))',
                        border: 'hsl(var(--border))',
                        input: 'hsl(var(--input))',
                        ring: 'hsl(var(--ring))',
                    },
                    borderRadius: {
                        lg: 'var(--radius)',
                        md: 'calc(var(--radius) - 2px)',
                        sm: 'calc(var(--radius) - 4px)',
                    }
                }
            }
        }
    </script>
</head>
<body class="min-h-screen flex items-center justify-center p-2 md:p-4">
    <div class="w-full max-w-3xl">
        <div id="alert" class="hidden p-4 mb-4 text-sm rounded-lg" role="alert"></div>

        <div class="bg-card text-card-foreground rounded-xl border shadow-lg">
            <div class="p-4 md:p-6">
                <div class="text-center space-y-1">
                    <p class="text-xs font-semibold tracking-wide text-primary uppercase">Paso a paso</p>
                    <h1 class="text-2xl md:text-3xl font-headline font-bold text-primary">Cuestionario Público</h1>
                    <p class="text-muted-foreground text-sm md:text-base">Queremos entender mejor tu necesidad. Son 4 pasos rápidos.</p>
                </div>

                
                <div class="mt-6">
                    <div class="flex items-center gap-3">
                        <div class="flex-1 h-2 rounded-full bg-secondary" aria-hidden="true">
                            <div id="progressBar" class="h-2 rounded-full bg-primary transition-all duration-200" style="width: 33%"></div>
                        </div>
                        <span id="stepLabel" class="text-xs font-semibold text-muted-foreground">Paso 1 de 3</span>
                    </div>
                </div>
            </div>

            <form id="questionnaireForm" class="p-4 md:p-6 pt-0 space-y-6">
                <div id="step-1" class="space-y-4">
                    <h2 class="text-lg font-semibold text-foreground">1. ¿Qué te interesa?</h2>
                    <div class="grid md:grid-cols-3 gap-4">
                        <label id="creditoOption" class="block cursor-pointer group">
                            <input type="radio" name="interes" value="credito" id="creditoRadio" class="peer sr-only">
                            <div id="creditoCard" class="border rounded-lg p-4 h-full transition hover:shadow-md peer-checked:border-primary peer-checked:ring-2 peer-checked:ring-primary/20 bg-background">
                                <p class="text-sm font-semibold text-foreground">Crédito</p>
                                <p class="text-xs text-muted-foreground mt-1">Financia tus metas y obligaciones.</p>
                            </div>
                        </label>
                        <label class="block cursor-pointer group">
                            <input type="radio" name="interes" value="servicios_legales" class="peer sr-only">
                            <div class="border rounded-lg p-4 h-full transition hover:shadow-md peer-checked:border-primary peer-checked:ring-2 peer-checked:ring-primary/20 bg-background">
                                <p class="text-sm font-semibold text-foreground">Servicios legales</p>
                                <p class="text-xs text-muted-foreground mt-1">Divorcios, traspasos, sucesiones u otros.</p>
                            </div>
                        </label>
                        <label id="ambosOption" class="block cursor-pointer group">
                            <input type="radio" name="interes" value="ambos" id="ambosRadio" class="peer sr-only">
                            <div id="ambosCard" class="border rounded-lg p-4 h-full transition hover:shadow-md peer-checked:border-primary peer-checked:ring-2 peer-checked:ring-primary/20 bg-background">
                                <p class="text-sm font-semibold text-foreground">Ambos</p>
                                <p class="text-xs text-muted-foreground mt-1">Necesito crédito y apoyo legal.</p>
                            </div>
                        </label>
                    </div>

                    <!-- Selección de servicios legales específicos -->
                    <div id="serviciosLegalesStep1" class="hidden space-y-3 mt-4 p-4 border rounded-lg bg-muted/30">
                        <p class="text-sm font-semibold text-foreground">¿Qué servicio legal necesitas?</p>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                            <label class="block cursor-pointer">
                                <input type="checkbox" name="tipo_servicio_legal" value="divorcio" class="peer sr-only">
                                <div class="border rounded-lg p-3 transition hover:shadow-md peer-checked:border-primary peer-checked:ring-2 peer-checked:ring-primary/20 bg-background text-center h-full">
                                    <p class="text-sm font-medium text-foreground">Divorcio</p>
                                </div>
                            </label>
                            <label class="block cursor-pointer">
                                <input type="checkbox" name="tipo_servicio_legal" value="pension_alimenticia" class="peer sr-only">
                                <div class="border rounded-lg p-3 transition hover:shadow-md peer-checked:border-primary peer-checked:ring-2 peer-checked:ring-primary/20 bg-background text-center h-full">
                                    <p class="text-sm font-medium text-foreground">Pensión alimenticia</p>
                                </div>
                            </label>
                            <label class="block cursor-pointer">
                                <input type="checkbox" name="tipo_servicio_legal" value="sucesion" class="peer sr-only">
                                <div class="border rounded-lg p-3 transition hover:shadow-md peer-checked:border-primary peer-checked:ring-2 peer-checked:ring-primary/20 bg-background text-center h-full">
                                    <p class="text-sm font-medium text-foreground">Sucesión</p>
                                </div>
                            </label>
                            <label class="block cursor-pointer">
                                <input type="checkbox" name="tipo_servicio_legal" value="notariado" class="peer sr-only">
                                <div class="border rounded-lg p-3 transition hover:shadow-md peer-checked:border-primary peer-checked:ring-2 peer-checked:ring-primary/20 bg-background text-center h-full">
                                    <p class="text-sm font-medium text-foreground">Notariado</p>
                                </div>
                            </label>
                            <label class="block cursor-pointer">
                                <input type="checkbox" name="tipo_servicio_legal" value="testamento" class="peer sr-only">
                                <div class="border rounded-lg p-3 transition hover:shadow-md peer-checked:border-primary peer-checked:ring-2 peer-checked:ring-primary/20 bg-background text-center h-full">
                                    <p class="text-sm font-medium text-foreground">Testamento</p>
                                </div>
                            </label>
                            <label class="block cursor-pointer">
                                <input type="checkbox" name="tipo_servicio_legal" value="traspaso" class="peer sr-only">
                                <div class="border rounded-lg p-3 transition hover:shadow-md peer-checked:border-primary peer-checked:ring-2 peer-checked:ring-primary/20 bg-background text-center h-full">
                                    <p class="text-sm font-medium text-foreground">Traspaso</p>
                                </div>
                            </label>
                            <label class="block cursor-pointer">
                                <input type="checkbox" name="tipo_servicio_legal" value="contrato" class="peer sr-only">
                                <div class="border rounded-lg p-3 transition hover:shadow-md peer-checked:border-primary peer-checked:ring-2 peer-checked:ring-primary/20 bg-background text-center h-full">
                                    <p class="text-sm font-medium text-foreground">Contrato</p>
                                </div>
                            </label>
                            <label class="block cursor-pointer">
                                <input type="checkbox" name="tipo_servicio_legal" value="otro" class="peer sr-only">
                                <div class="border rounded-lg p-3 transition hover:shadow-md peer-checked:border-primary peer-checked:ring-2 peer-checked:ring-primary/20 bg-background text-center h-full">
                                    <p class="text-sm font-medium text-foreground">Otro</p>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>

                <div id="step-2" class="space-y-4 hidden">
                    <h2 class="text-lg font-semibold text-foreground">2. Detalles de tu necesidad</h2>

                    <div id="creditoFields" class="space-y-3 hidden">
                        <p class="text-sm font-semibold text-muted-foreground">Crédito</p>
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-foreground">Tipo de crédito *</label>
                            <div class="grid grid-cols-2 gap-3">
                                <label class="block cursor-pointer">
                                    <input type="radio" name="tipo_credito" value="microcredito" class="peer sr-only">
                                    <div class="border rounded-lg p-3 transition hover:shadow-md peer-checked:border-primary peer-checked:ring-2 peer-checked:ring-primary/20 bg-background text-center">
                                        <p class="text-sm font-medium text-foreground">Microcrédito</p>
                                        <p id="microRangeLabel" class="text-xs text-muted-foreground">Cargando...</p>
                                    </div>
                                </label>
                                <label class="block cursor-pointer">
                                    <input type="radio" name="tipo_credito" value="regular" class="peer sr-only">
                                    <div class="border rounded-lg p-3 transition hover:shadow-md peer-checked:border-primary peer-checked:ring-2 peer-checked:ring-primary/20 bg-background text-center">
                                        <p class="text-sm font-medium text-foreground">Crédito Regular</p>
                                        <p id="regularRangeLabel" class="text-xs text-muted-foreground">Cargando...</p>
                                    </div>
                                </label>
                            </div>
                        </div>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-foreground mb-1">Monto aproximado *</label>
                                <select name="monto" id="montoSelect" class="w-full px-3 py-2 bg-background border border-input rounded-md text-sm">
                                    <option value="">Primero selecciona el tipo de crédito</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-foreground mb-1">Uso del crédito *</label>
                                <select name="uso_credito" class="w-full px-3 py-2 bg-background border border-input rounded-md text-sm">
                                    <option value="">Selecciona</option>
                                    <option value="consumo">Consumo / personales</option>
                                    <option value="consolidacion">Consolidación de deudas</option>
                                    <option value="negocio">Negocio / capital de trabajo</option>
                                </select>
                            </div>
                        </div>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div id="institucionWrapper">
                                <label class="block text-sm font-medium text-foreground mb-1">Institución en la que labora *</label>
                                <div id="institucionContainer" class="relative">
                                    <button type="button" id="institucionTrigger" class="w-full h-10 px-3 bg-background border border-input rounded-md text-sm text-left flex items-center justify-between">
                                        <span id="institucionLabel" class="truncate text-muted-foreground">Selecciona institución</span>
                                        <span class="text-xs text-muted-foreground">▼</span>
                                    </button>
                                    <div id="institucionDropdown" class="hidden absolute z-20 mt-1 w-full rounded-md border bg-white shadow-lg">
                                        <div class="p-2 border-b">
                                            <input id="institucionSearch" type="text" placeholder="Buscar institución" class="w-full px-2 py-1 text-sm border rounded-md" aria-label="Buscar institución">
                                        </div>
                                        <div id="institucionList" class="max-h-40 overflow-y-auto"></div>
                                    </div>
                                    <input type="hidden" id="institucionValue" name="institucion" value="">
                                </div>
                            </div>
                            <div id="empresaWrapper">
                                <label class="block text-sm font-medium text-foreground mb-1">Empresa en la que Labora</label>
                                <div id="companyContainer" class="relative">
                                    <button type="button" id="companyTrigger" class="w-full h-10 px-3 bg-background border border-input rounded-md text-sm text-left flex items-center justify-between">
                                        <span id="companyLabel" class="truncate text-muted-foreground">Selecciona</span>
                                        <span class="text-xs text-muted-foreground">▼</span>
                                    </button>
                                    <div id="companyDropdown" class="hidden absolute z-20 mt-1 w-full rounded-md border bg-white shadow-lg">
                                        <div class="p-2 border-b">
                                            <input id="companySearch" type="text" placeholder="Buscar empresa" class="w-full px-2 py-1 text-sm border rounded-md" aria-label="Buscar empresa">
                                        </div>
                                        <div id="companyList" class="max-h-40 overflow-y-auto"></div>
                                    </div>
                                    <input type="hidden" id="companyValue" name="situacion_laboral" value="">
                                </div>
                            </div>
                        </div>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-foreground mb-1">Tiempo laborando</label>
                                <select name="antiguedad_laboral" class="w-full px-3 py-2 bg-background border border-input rounded-md text-sm">
                                    <option value="">Selecciona</option>
                                    <option value="<1a">Menos de 1 año</option>
                                    <option value="1-3a">1 a 3 años</option>
                                    <option value="3-5a">3 a 5 años</option>
                                    <option value=">5a">Más de 5 años</option>
                                </select>
                            </div>
                        </div>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-foreground mb-1">Rango de ingreso mensual *</label>
                                <select name="ingreso" id="ingresoSelect" class="w-full px-3 py-2 bg-background border border-input rounded-md text-sm">
                                    <option value="">Selecciona</option>
                                    <option value="<300k">Menor a ₡300,000</option>
                                    <option value="300k-500k">₡300,000 - ₡500,000</option>
                                    <option value="500k-800k">₡500,000 - ₡800,000</option>
                                    <option value="800k-1.2m">₡800,000 - ₡1,200,000</option>
                                    <option value=">1.2m">Más de ₡1,200,000</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-foreground mb-1">Salario exacto (₡) *</label>
                                <input type="text" name="salario_exacto" id="salarioExacto" placeholder="Ej: 450000" class="w-full px-3 py-2 bg-background border border-input rounded-md text-sm">
                                <p id="salarioError" class="text-xs text-red-500 mt-1 hidden">El salario debe estar dentro del rango seleccionado</p>
                            </div>
                        </div>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-foreground mb-1">¿Tienes deudas actualmente? *</label>
                                <select name="tiene_deudas" class="w-full px-3 py-2 bg-background border border-input rounded-md text-sm">
                                    <option value="">Selecciona</option>
                                    <option value="no">No</option>
                                    <option value="si_1_2">Sí, 1-2 créditos</option>
                                    <option value="si_3_mas">Sí, 3 o más</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div id="legalesFields" class="space-y-3 hidden">
                        <p class="text-sm font-semibold text-muted-foreground">Servicios legales</p>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-foreground mb-1">Tipo de trámite</label>
                                <div class="space-y-2 border rounded-md p-3 bg-background">
                                    <label class="flex items-center gap-2 text-sm text-foreground">
                                        <input type="checkbox" name="tramites" value="divorcio" class="h-4 w-4 text-primary border-input rounded">
                                        <span>Divorcio</span>
                                    </label>
                                    <label class="flex items-center gap-2 text-sm text-foreground">
                                        <input type="checkbox" name="tramites" value="traspaso" class="h-4 w-4 text-primary border-input rounded">
                                        <span>Traspaso de bienes</span>
                                    </label>
                                    <label class="flex items-center gap-2 text-sm text-foreground">
                                        <input type="checkbox" name="tramites" value="sucesion" class="h-4 w-4 text-primary border-input rounded">
                                        <span>Sucesiones</span>
                                    </label>
                                    <label class="flex items-center gap-2 text-sm text-foreground">
                                        <input type="checkbox" name="tramites" value="otros" class="h-4 w-4 text-primary border-input rounded">
                                        <span>Otros</span>
                                    </label>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-foreground mb-1">Urgencia</label>
                                <select name="urgencia" class="w-full px-3 py-2 bg-background border border-input rounded-md text-sm">
                                    <option value="">Selecciona</option>
                                    <option value="inmediata">Inmediata (menos de 15 días)</option>
                                    <option value="30-60">En 30 - 60 días</option>
                                    <option value=">60">En más de 60 días</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-foreground mb-1">Breve descripción</label>
                            <textarea name="detalle_legal" rows="3" class="w-full px-3 py-2 bg-background border border-input rounded-md text-sm" placeholder="Cuéntanos el contexto del trámite"></textarea>
                        </div>
                    </div>
                </div>

                <div id="step-3" class="space-y-4 hidden">
                    <h2 class="text-lg font-semibold text-foreground">3. Perfil financiero</h2>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-foreground mb-1">¿Has tenido créditos antes? *</label>
                            <select name="experiencia_crediticia" class="w-full px-3 py-2 bg-background border border-input rounded-md text-sm">
                                <option value="">Selecciona</option>
                                <option value="si_bancarios">Sí, con bancos</option>
                                <option value="si_cooperativas">Sí, con cooperativas</option>
                                <option value="si_otros">Sí, con otras entidades</option>
                                <option value="no">No, es mi primer crédito</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-foreground mb-1">Historial de pagos *</label>
                            <select name="historial_mora" class="w-full px-3 py-2 bg-background border border-input rounded-md text-sm">
                                <option value="">Selecciona</option>
                                <option value="siempre_al_dia">Siempre al día</option>
                                <option value="atrasos_ocasionales">Atrasos ocasionales (1-2 veces)</option>
                                <option value="atrasos_frecuentes">Atrasos frecuentes</option>
                                <option value="no_aplica">No aplica / Primer crédito</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-foreground mb-1">Tipo de vivienda *</label>
                            <select name="tipo_vivienda" class="w-full px-3 py-2 bg-background border border-input rounded-md text-sm">
                                <option value="">Selecciona</option>
                                <option value="propia_pagada">Propia (pagada)</option>
                                <option value="propia_hipotecada">Propia (con hipoteca)</option>
                                <option value="alquilada">Alquilada</option>
                                <option value="familiar">Familiar / Prestada</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-foreground mb-1">Personas a tu cargo *</label>
                            <select name="dependientes" class="w-full px-3 py-2 bg-background border border-input rounded-md text-sm">
                                <option value="">Selecciona</option>
                                <option value="0">Ninguna</option>
                                <option value="1-2">1 - 2 personas</option>
                                <option value="3-4">3 - 4 personas</option>
                                <option value=">4">Más de 4 personas</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-foreground mb-1">Estado civil *</label>
                            <select name="estado_civil" class="w-full px-3 py-2 bg-background border border-input rounded-md text-sm">
                                <option value="">Selecciona</option>
                                <option value="soltero">Soltero(a)</option>
                                <option value="casado">Casado(a)</option>
                                <option value="union_libre">Unión libre</option>
                                <option value="divorciado">Divorciado(a)</option>
                                <option value="viudo">Viudo(a)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-foreground mb-1">Nivel académico *</label>
                            <select name="nivel_academico" class="w-full px-3 py-2 bg-background border border-input rounded-md text-sm">
                                <option value="">Selecciona</option>
                                <option value="primaria">Primaria</option>
                                <option value="secundaria">Secundaria</option>
                                <option value="tecnico">Técnico / Vocacional</option>
                                <option value="universitario">Universitario</option>
                                <option value="posgrado">Posgrado</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-foreground mb-1">¿Cómo conociste Credipep?</label>
                        <select name="origen_lead" class="w-full px-3 py-2 bg-background border border-input rounded-md text-sm">
                            <option value="">Selecciona</option>
                            <option value="redes_sociales">Redes sociales</option>
                            <option value="recomendacion">Recomendación</option>
                            <option value="google">Búsqueda en Google</option>
                            <option value="publicidad">Publicidad</option>
                            <option value="otro">Otro</option>
                        </select>
                    </div>
                </div>

                <div id="step-4" class="space-y-4 hidden">
                    <h2 class="text-lg font-semibold text-foreground">4. Documentos requeridos</h2>
                    <p class="text-sm text-muted-foreground">Para completar tu solicitud, por favor adjunta los siguientes documentos.</p>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-foreground mb-2">Cédula de identidad (imagen) *</label>
                            <div class="border-2 border-dashed border-border rounded-lg p-6 text-center hover:border-primary transition-colors cursor-pointer" id="cedulaDropZone">
                                <input type="file" id="cedulaFile" name="cedula_file" accept="image/*" class="hidden" required>
                                <div id="cedulaPlaceholder">
                                    <svg class="w-12 h-12 mx-auto text-muted-foreground mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                    </svg>
                                    <p class="text-sm text-foreground font-medium">Click para seleccionar tu cédula</p>
                                    <p class="text-xs text-muted-foreground mt-1">o arrastra la imagen aquí</p>
                                    <p class="text-xs text-muted-foreground mt-1">PNG, JPG hasta 5MB</p>
                                </div>
                                <div id="cedulaPreview" class="hidden">
                                    <img id="cedulaImage" class="max-w-full h-auto rounded-md mx-auto" style="max-height: 200px;">
                                    <p id="cedulaFileName" class="text-sm text-foreground font-medium mt-2"></p>
                                    <button type="button" id="cedulaRemove" class="mt-2 text-xs text-red-600 hover:text-red-700 font-medium">Eliminar</button>
                                </div>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-foreground mb-2">Recibo de servicio (imagen o PDF) *</label>
                            <div class="border-2 border-dashed border-border rounded-lg p-6 text-center hover:border-primary transition-colors cursor-pointer" id="reciboDropZone">
                                <input type="file" id="reciboFile" name="recibo_file" accept="image/*,application/pdf" class="hidden" required>
                                <div id="reciboPlaceholder">
                                    <svg class="w-12 h-12 mx-auto text-muted-foreground mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                    <p class="text-sm text-foreground font-medium">Click para seleccionar tu recibo</p>
                                    <p class="text-xs text-muted-foreground mt-1">o arrastra el archivo aquí</p>
                                    <p class="text-xs text-muted-foreground mt-1">PNG, JPG, PDF hasta 5MB</p>
                                </div>
                                <div id="reciboPreview" class="hidden">
                                    <div id="reciboImageContainer" class="hidden">
                                        <img id="reciboImage" class="max-w-full h-auto rounded-md mx-auto" style="max-height: 200px;">
                                    </div>
                                    <div id="reciboPdfContainer" class="hidden">
                                        <svg class="w-16 h-16 mx-auto text-red-600 mb-2" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd"></path>
                                        </svg>
                                    </div>
                                    <p id="reciboFileName" class="text-sm text-foreground font-medium mt-2"></p>
                                    <button type="button" id="reciboRemove" class="mt-2 text-xs text-red-600 hover:text-red-700 font-medium">Eliminar</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-6 p-4 bg-accent/50 rounded-lg border border-border/50">
                        <div class="flex items-start gap-3">
                            <svg class="w-5 h-5 text-primary flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                            </svg>
                            <div class="flex-1">
                                <p class="text-sm font-semibold text-foreground mb-2">Protección de datos personales</p>
                                <p class="text-xs text-muted-foreground leading-relaxed">
                                    Los datos y documentos que nos proporcionas están protegidos bajo nuestra política de privacidad y la normativa de protección de datos personales.
                                    Serán utilizados exclusivamente para procesar tu solicitud de crédito o servicios legales. Tus archivos se almacenan de forma segura
                                    y solo el personal autorizado tendrá acceso a ellos. Al enviar este formulario, aceptas nuestros términos y condiciones.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex items-center justify-between pt-2">
                    <button type="button" id="backBtn" class="inline-flex items-center gap-2 rounded-md border px-4 py-2 text-sm font-medium text-foreground bg-background hover:bg-accent disabled:opacity-50" disabled>Atrás</button>
                    <div class="flex items-center gap-2">
                        <button type="button" id="nextBtn" class="inline-flex items-center justify-center rounded-md text-sm font-medium bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2">Siguiente</button>
                        <button type="submit" id="submitBtn" class="hidden inline-flex items-center justify-center rounded-md text-sm font-medium bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2">Enviar</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Diálogo de salario bajo - bloquear crédito -->
    <div id="salarioBajoDialog" class="hidden fixed inset-0 z-50 flex items-center justify-center">
        <div class="fixed inset-0 bg-black/50"></div>
        <div class="relative bg-card rounded-xl shadow-2xl p-6 md:p-8 max-w-md mx-4 text-center" style="animation: fadeIn 0.2s ease-out;">
            <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-8 h-8 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
            </div>
            <h2 class="text-xl font-headline font-bold text-foreground mb-2">Información Importante</h2>
            <p class="text-muted-foreground mb-6">Lamentamos informarte que actualmente no contamos con créditos para clientes del sector público cuyo salario sea menor a ₡300,000. Sin embargo, puedes optar por nuestros <strong>créditos para servicios legales</strong> (divorcios, notariado, testamentos, etc.).</p>
            <button onclick="closeSalarioBajoDialog()" class="w-full inline-flex items-center justify-center rounded-md text-sm font-medium bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2">Entendido</button>
        </div>
    </div>

    <div id="successDialog" class="hidden fixed inset-0 z-50 flex items-center justify-center">
        <div class="fixed inset-0 bg-black/50" onclick="closeSuccessDialog()"></div>
        <div class="relative bg-card rounded-xl shadow-2xl p-6 md:p-8 max-w-md mx-4 text-center" style="animation: fadeIn 0.2s ease-out;">
            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
            </div>
            <h2 class="text-xl font-headline font-bold text-foreground mb-2">Listo</h2>
            <p class="text-muted-foreground mb-6">¡Pronto un asesor de Credipep te escribirá para ayudarte!</p>
            <button onclick="closeSuccessDialog()" class="w-full inline-flex items-center justify-center rounded-md text-sm font-medium bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2">Entendido</button>
        </div>
    </div>

    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
    </style>

    <script>
        const steps = ['step-1', 'step-2', 'step-3', 'step-4'];
        let currentStep = 0;

        function showStep(index) {
            steps.forEach((id, i) => {
                const el = document.getElementById(id);
                if (!el) return;
                el.classList.toggle('hidden', i !== index);
            });
            document.getElementById('backBtn').disabled = index === 0;
            document.getElementById('nextBtn').classList.toggle('hidden', index === steps.length - 1);
            document.getElementById('submitBtn').classList.toggle('hidden', index !== steps.length - 1);
            const percent = ((index + 1) / steps.length) * 100;
            document.getElementById('progressBar').style.width = `${percent}%`;
            document.getElementById('stepLabel').textContent = `Paso ${index + 1} de ${steps.length}`;
        }

        function showAlert(message, type = 'error') {
            const alert = document.getElementById('alert');
            alert.textContent = message;
            alert.className = `p-4 mb-4 text-sm rounded-lg ${type === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`;
            alert.classList.remove('hidden');
            if (type === 'success') {
                setTimeout(() => alert.classList.add('hidden'), 4000);
            }
        }

        function clearAlert() {
            document.getElementById('alert').classList.add('hidden');
        }

        // Configuraciones de préstamos (se cargan desde la API)
        let loanConfigs = {
            microcredito: { monto_minimo: 100000, monto_maximo: 1000000 },
            regular: { monto_minimo: 500000, monto_maximo: 10000000 }
        };
        let montosMicrocredito = [];
        let montosRegular = [];

        // Formatear número a colones
        function formatCurrency(num) {
            return '₡' + num.toLocaleString('en-US');
        }

        // Redondear a número "bonito" (múltiplo de 50,000 o 100,000)
        function redondearMonto(num, direccion = 'down') {
            // Para montos menores a 1M, redondear a múltiplos de 50,000
            // Para montos mayores, redondear a múltiplos de 100,000 o 500,000
            let multiplo;
            if (num < 500000) {
                multiplo = 50000;
            } else if (num < 2000000) {
                multiplo = 100000;
            } else {
                multiplo = 500000;
            }

            if (direccion === 'up') {
                return Math.ceil(num / multiplo) * multiplo;
            } else {
                return Math.floor(num / multiplo) * multiplo;
            }
        }

        // Generar rangos de monto automáticamente con números redondeados
        function generarRangosMonto(min, max) {
            const rangos = [];
            const rango = max - min;
            const paso = rango / 3;

            for (let i = 0; i < 3; i++) {
                let desde, hasta;

                if (i === 0) {
                    desde = min; // El mínimo se mantiene
                } else {
                    desde = redondearMonto(min + (paso * i), 'up');
                }

                if (i === 2) {
                    hasta = max; // El máximo se mantiene
                } else {
                    hasta = redondearMonto(min + (paso * (i + 1)), 'down');
                }

                // Crear value legible
                const desdeK = desde / 1000;
                const hastaK = hasta / 1000;
                let value;
                if (hastaK >= 1000) {
                    value = (desdeK / 1000).toFixed(1) + 'm-' + (hastaK / 1000).toFixed(1) + 'm';
                } else {
                    value = Math.round(desdeK) + 'k-' + Math.round(hastaK) + 'k';
                }

                rangos.push({
                    value: value,
                    label: formatCurrency(desde) + ' - ' + formatCurrency(hasta),
                    min: desde,
                    max: hasta
                });
            }
            return rangos;
        }

        // Cargar configuraciones desde la API
        async function loadLoanConfigurations() {
            try {
                const response = await fetch('/api/loan-configurations');
                const configs = await response.json();

                const micro = configs.find(c => c.tipo === 'microcredito');
                const regular = configs.find(c => c.tipo === 'regular');

                if (micro) {
                    loanConfigs.microcredito = micro;
                    montosMicrocredito = generarRangosMonto(
                        parseFloat(micro.monto_minimo),
                        parseFloat(micro.monto_maximo)
                    );
                    // Actualizar etiqueta
                    const microLabel = document.getElementById('microRangeLabel');
                    if (microLabel) {
                        microLabel.textContent = formatCurrency(parseFloat(micro.monto_minimo)) + ' - ' + formatCurrency(parseFloat(micro.monto_maximo));
                    }
                }

                if (regular) {
                    loanConfigs.regular = regular;
                    montosRegular = generarRangosMonto(
                        parseFloat(regular.monto_minimo),
                        parseFloat(regular.monto_maximo)
                    );
                    // Actualizar etiqueta
                    const regularLabel = document.getElementById('regularRangeLabel');
                    if (regularLabel) {
                        regularLabel.textContent = formatCurrency(parseFloat(regular.monto_minimo)) + ' - ' + formatCurrency(parseFloat(regular.monto_maximo));
                    }
                }

                console.log('Configuraciones cargadas:', loanConfigs);
            } catch (error) {
                console.error('Error cargando configuraciones de préstamos:', error);
                // Usar valores por defecto si falla la API
                montosMicrocredito = generarRangosMonto(100000, 1000000);
                montosRegular = generarRangosMonto(500000, 10000000);

                const microLabel = document.getElementById('microRangeLabel');
                if (microLabel) microLabel.textContent = '₡100,000 - ₡1,000,000';
                const regularLabel = document.getElementById('regularRangeLabel');
                if (regularLabel) regularLabel.textContent = '₡500,000 - ₡10,000,000';
            }
        }

        // Rangos de salario para validación
        const rangosIngreso = {
            '<300k': { min: 0, max: 299999 },
            '300k-500k': { min: 300000, max: 500000 },
            '500k-800k': { min: 500000, max: 800000 },
            '800k-1.2m': { min: 800000, max: 1200000 },
            '>1.2m': { min: 1200001, max: Infinity }
        };

        function updateMontoOptions() {
            const tipoCredito = document.querySelector('input[name="tipo_credito"]:checked')?.value;
            const montoSelect = document.getElementById('montoSelect');

            if (!montoSelect) {
                console.error('No se encontró el select de montos');
                return;
            }

            // Limpiar opciones actuales
            while (montoSelect.firstChild) {
                montoSelect.removeChild(montoSelect.firstChild);
            }

            // Agregar opción por defecto
            const defaultOpt = document.createElement('option');
            defaultOpt.value = '';
            defaultOpt.textContent = 'Selecciona un monto';
            montoSelect.appendChild(defaultOpt);

            // Seleccionar montos según tipo
            let montos = [];
            if (tipoCredito === 'microcredito') {
                montos = montosMicrocredito;
            } else if (tipoCredito === 'regular') {
                montos = montosRegular;
            }

            // Agregar opciones
            montos.forEach(function(m) {
                const opt = document.createElement('option');
                opt.value = m.value;
                opt.textContent = m.label;
                montoSelect.appendChild(opt);
            });
        }

        function formatSalario(value) {
            // Solo números
            const numericValue = value.replace(/[^0-9]/g, '');
            // Formato con comas
            return numericValue.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }

        function validateSalario() {
            const ingresoSelect = document.getElementById('ingresoSelect');
            const salarioInput = document.getElementById('salarioExacto');
            const errorEl = document.getElementById('salarioError');
            const rangoKey = ingresoSelect.value;
            const salarioRaw = salarioInput.value.replace(/[^0-9]/g, '');
            const salario = parseInt(salarioRaw) || 0;

            if (!rangoKey || !salarioRaw) {
                errorEl.classList.add('hidden');
                return true;
            }

            const rango = rangosIngreso[rangoKey];
            if (salario < rango.min || salario > rango.max) {
                errorEl.classList.remove('hidden');
                salarioInput.classList.add('border-red-500');
                return false;
            } else {
                errorEl.classList.add('hidden');
                salarioInput.classList.remove('border-red-500');
                return true;
            }
        }

        function updateDynamicBlocks() {
            const interes = document.querySelector('input[name="interes"]:checked')?.value;
            const showCredito = interes === 'credito' || interes === 'ambos';
            const showLegales = interes === 'servicios_legales' || interes === 'ambos';
            document.getElementById('creditoFields').classList.toggle('hidden', !showCredito);
            document.getElementById('legalesFields').classList.toggle('hidden', !showLegales);

            // Mostrar/ocultar servicios legales en step-1
            const serviciosLegalesStep1 = document.getElementById('serviciosLegalesStep1');
            if (serviciosLegalesStep1) {
                serviciosLegalesStep1.classList.toggle('hidden', !showLegales);
            }
        }

        const companyOptions = [
            'A.N.E.P.',
            'ARCHIVO NACIONAL',
            'ASAMBLEA LEGISLATIVA',
            'AVIACION CIVIL',
            'AYA',
            'C.C.S.S',
            'C.N.P.',
            'CEN-CINAI',
            'CN MUSICA',
            'CNC',
            'CONAVI',
            'CONTROL DE MIGRACIÓN Y EXTRANJERÍA',
            'CORONADO',
            'COSEVI',
            'DEFENSORÍA DE LOS HABITANTES',
            'DESARROLLO DE LA COMUNIDAD',
            'DIRECCIÓN GENERAL DE SERVICIO CIVIL',
            'DIRECCIÓN NACIONAL DE PENSIONES',
            'FANAL',
            'FITOSANITARIO',
            'FONAFIFO',
            'GOBIERNO CENTRAL INTEGRA',
            'I.A.F.A.',
            'I.C.E.',
            'I.C.O.D.E.R',
            'I.M.A.S',
            'ICE',
            'ICE EMERGENCIAS 911',
            'ICE ENERGIA Y TELEC.',
            'IFAM',
            'IMPRENTA NACIONAL',
            'INA',
            'INDER (IDA)',
            'INTA',
            'INVU',
            'JUNTA ADM. REGISTRO NACIONAL',
            'MIN DE AGRICULTURA Y GANADERÍA',
            'MIN DE CIENCIA TECNOLOGÍA Y TELECOMUNICACIONES',
            'MIN DE COMERCIO EXTERIOR',
            'MIN DE CULT.JUV Y DEPORTES',
            'MIN DE ECO.IND Y COMERCIO',
            'MIN DE GOBERNACIÓN Y POLICÍA',
            'MINAE',
            'MINISTERIO DE AMBIENTE Y ENERGÍA',
            'MINISTERIO DE EDUCACIÓN PÚBLICA',
            'MINISTERIO DE HACIENDA',
            'MINISTERIO DE JUSTICIA Y GRACIA',
            'MINISTERIO DE LA PRESIDENCIA',
            'MINISTERIO DE OBRAS PUBL. Y TRANSPORTE',
            'MINISTERIO DE PLANIF.NAC Y POL.ECO',
            'MINISTERIO DE RELACIONES EXTERIORES Y CULTO',
            'MINISTERIO DE SALUD',
            'MINISTERIO DE SEGURIDAD PÚBLICA',
            'MINISTERIO DE TRAB. Y SEGUR. SOC',
            'MINISTERIO DE VIVIENDA Y ASENT.HUMANOS',
            'MUNICIPALIDAD DE ALVARADO',
            'MUNICIPALIDAD DE ASERRI',
            'MUNICIPALIDAD DE CORONADO',
            'MUNICIPALIDAD DE CORREDORES',
            'MUNICIPALIDAD DE DESAMPARADOS',
            'MUNICIPALIDAD DE GOICOECHEA',
            'MUNICIPALIDAD DE MORA',
            'MUNICIPALIDAD DE MORAVIA',
            'MUNICIPALIDAD DE NARANJO',
            'MUNICIPALIDAD DE OREAMUNO',
            'MUNICIPALIDAD DE OROTIÑA',
            'MUNICIPALIDAD DE PALMARES',
            'MUNICIPALIDAD DE PARRITA',
            'MUNICIPALIDAD DE PUNTARENAS',
            'MUNICIPALIDAD DE SAN MATEO',
            'MUNICIPALIDAD DE SAN PABLO',
            'MUNICIPALIDAD DE SAN VITO',
            'MUNICIPALIDAD DE TIBÁS',
            'MUNICIPALIDAD GRECIA',
            'MUNICIPALIDAD SAN JOSÉ',
            'MUSEO NACIONAL',
            'O.T.M.',
            'P.A.N.I',
            'PENSIONADOS PODER JUDICIAL',
            'PERSONA JOVEN',
            'PODER JUDICIAL',
            'PRESIDENCIA DE LA REPÚBLICA',
            'PROCURADURÍA GENERAL DE LA REPÚBLICA',
            'RECOPE',
            'REGISTRO NACIONAL',
            'SEC',
            'SENASA',
            'SERVICIO EXTERIOR',
            'TEATRO NACIONAL',
            'TRIBUNAL DE SERVICIO CIVIL',
            'TRIBUNAL SUPREMO DE ELECCIONES',
            'UCR',
            'UCR UNIVERSIDAD DE COSTA RICA'
        ];

        function renderCompanyOptions(filter = '') {
            const list = document.getElementById('companyList');
            list.innerHTML = '';
            const term = filter.trim().toLowerCase();
            companyOptions.forEach(name => {
                if (term && !name.toLowerCase().includes(term)) return;
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.textContent = name;
                btn.className = 'w-full text-left px-3 py-2 text-sm hover:bg-gray-100';
                btn.addEventListener('click', () => selectCompany(name));
                list.appendChild(btn);
            });
            if (!list.children.length) {
                const empty = document.createElement('div');
                empty.className = 'px-3 py-2 text-sm text-muted-foreground';
                empty.textContent = 'Sin resultados';
                list.appendChild(empty);
            }
        }

        function selectCompany(name) {
            const hidden = document.getElementById('companyValue');
            const label = document.getElementById('companyLabel');
            hidden.value = name || '';
            label.textContent = name || 'Selecciona';
            label.classList.toggle('text-muted-foreground', !name);
            closeCompanyDropdown();
        }

        function openCompanyDropdown() {
            document.getElementById('companyDropdown').classList.remove('hidden');
            renderCompanyOptions(document.getElementById('companySearch').value || '');
            document.getElementById('companySearch').focus();
        }

        function closeCompanyDropdown() {
            document.getElementById('companyDropdown').classList.add('hidden');
        }

        function toggleCompanyDropdown() {
            const dropdown = document.getElementById('companyDropdown');
            if (dropdown.classList.contains('hidden')) {
                openCompanyDropdown();
            } else {
                closeCompanyDropdown();
            }
        }

        // --- Instituciones Dropdown ---
        let institucionOptions = [];

        async function loadInstituciones() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/instituciones?activas_only=true`);
                if (response.ok) {
                    const data = await response.json();
                    institucionOptions = data.map(inst => inst.nombre);
                    renderInstitucionOptions();
                }
            } catch (error) {
                console.error('Error loading instituciones:', error);
            }
        }

        function renderInstitucionOptions(filter = '') {
            const list = document.getElementById('institucionList');
            if (!list) return;
            list.innerHTML = '';
            const term = filter.trim().toLowerCase();
            institucionOptions.forEach(name => {
                if (term && !name.toLowerCase().includes(term)) return;
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.textContent = name;
                btn.className = 'w-full text-left px-3 py-2 text-sm hover:bg-gray-100';
                btn.addEventListener('click', () => selectInstitucion(name));
                list.appendChild(btn);
            });
            if (!list.children.length) {
                const empty = document.createElement('div');
                empty.className = 'px-3 py-2 text-sm text-muted-foreground';
                empty.textContent = 'Sin resultados';
                list.appendChild(empty);
            }
        }

        function selectInstitucion(name) {
            const hidden = document.getElementById('institucionValue');
            const label = document.getElementById('institucionLabel');
            hidden.value = name || '';
            label.textContent = name || 'Selecciona institución';
            label.classList.toggle('text-muted-foreground', !name);
            closeInstitucionDropdown();
        }

        function openInstitucionDropdown() {
            document.getElementById('institucionDropdown').classList.remove('hidden');
            renderInstitucionOptions(document.getElementById('institucionSearch').value || '');
            document.getElementById('institucionSearch').focus();
        }

        function closeInstitucionDropdown() {
            document.getElementById('institucionDropdown').classList.add('hidden');
        }

        function toggleInstitucionDropdown() {
            const dropdown = document.getElementById('institucionDropdown');
            if (dropdown.classList.contains('hidden')) {
                openInstitucionDropdown();
            } else {
                closeInstitucionDropdown();
            }
        }

        function validateStep(index) {
            clearAlert();
            if (index === 0) {
                const interes = document.querySelector('input[name="interes"]:checked');
                if (!interes) {
                    showAlert('Selecciona qué te interesa para continuar.');
                    return false;
                }
            }
            if (index === 1) {
                const interes = document.querySelector('input[name="interes"]:checked')?.value;
                if (interes === 'credito' || interes === 'ambos') {
                    const tipoCredito = document.querySelector('input[name="tipo_credito"]:checked')?.value;
                    const monto = document.querySelector('select[name="monto"]').value;
                    const uso = document.querySelector('select[name="uso_credito"]').value;
                    const situacion = document.getElementById('companyValue').value;
                    const ingreso = document.getElementById('ingresoSelect').value;
                    const salario = document.getElementById('salarioExacto').value.replace(/[^0-9]/g, '');

                    if (!tipoCredito) {
                        showAlert('Selecciona el tipo de crédito (Microcrédito o Regular).');
                        return false;
                    }
                    if (!monto || !uso || !situacion || !ingreso || !salario) {
                        showAlert('Completa todos los datos de crédito.');
                        return false;
                    }
                    if (!validateSalario()) {
                        showAlert('El salario debe estar dentro del rango de ingreso seleccionado.');
                        return false;
                    }
                }
                if (interes === 'servicios_legales' || interes === 'ambos') {
                    const tramites = Array.from(document.querySelectorAll('input[name="tramites"]:checked'));
                    const urgencia = document.querySelector('select[name="urgencia"]').value;
                    if (tramites.length === 0 || !urgencia) {
                        showAlert('Selecciona al menos un trámite legal y la urgencia.');
                        return false;
                    }
                }
            }
            if (index === 2) {
                const experiencia = document.querySelector('select[name="experiencia_crediticia"]').value;
                const historial = document.querySelector('select[name="historial_mora"]').value;
                const vivienda = document.querySelector('select[name="tipo_vivienda"]').value;
                const dependientes = document.querySelector('select[name="dependientes"]').value;
                const estadoCivil = document.querySelector('select[name="estado_civil"]').value;
                const nivelAcademico = document.querySelector('select[name="nivel_academico"]').value;
                if (!experiencia || !historial || !vivienda || !dependientes || !estadoCivil || !nivelAcademico) {
                    showAlert('Completa todos los campos obligatorios del perfil financiero.');
                    return false;
                }
            }
            if (index === 3) {
                const cedulaFile = document.getElementById('cedulaFile').files[0];
                const reciboFile = document.getElementById('reciboFile').files[0];
                if (!cedulaFile) {
                    showAlert('Por favor adjunta una imagen de tu cédula.');
                    return false;
                }
                if (!reciboFile) {
                    showAlert('Por favor adjunta tu recibo de servicio.');
                    return false;
                }
                // Validate file sizes (max 5MB)
                if (cedulaFile.size > 5 * 1024 * 1024) {
                    showAlert('La imagen de la cédula no debe superar 5MB.');
                    return false;
                }
                if (reciboFile.size > 5 * 1024 * 1024) {
                    showAlert('El recibo no debe superar 5MB.');
                    return false;
                }
            }
            return true;
        }

        function collectData() {
            const interes = document.querySelector('input[name="interes"]:checked')?.value || '';
            const data = { interes };
            if (interes === 'credito' || interes === 'ambos') {
                data.tipo_credito = document.querySelector('input[name="tipo_credito"]:checked')?.value || '';
                data.monto = document.querySelector('select[name="monto"]').value;
                data.uso_credito = document.querySelector('select[name="uso_credito"]').value;
                data.situacion_laboral = document.getElementById('companyValue').value;
                data.ingreso = document.getElementById('ingresoSelect').value;
                data.salario_exacto = document.getElementById('salarioExacto').value.replace(/[^0-9]/g, '');
                data.tiene_deudas = document.querySelector('select[name="tiene_deudas"]').value;
            }
            if (interes === 'servicios_legales' || interes === 'ambos') {
                data.tramites = Array.from(document.querySelectorAll('input[name="tramites"]:checked')).map(el => el.value);
                data.urgencia = document.querySelector('select[name="urgencia"]').value;
                data.detalle_legal = document.querySelector('textarea[name="detalle_legal"]').value;
            }
            data.experiencia_crediticia = document.querySelector('select[name="experiencia_crediticia"]').value;
            data.historial_mora = document.querySelector('select[name="historial_mora"]').value;
            data.tipo_vivienda = document.querySelector('select[name="tipo_vivienda"]').value;
            data.dependientes = document.querySelector('select[name="dependientes"]').value;
            data.estado_civil = document.querySelector('select[name="estado_civil"]').value;
            data.nivel_academico = document.querySelector('select[name="nivel_academico"]').value;
            data.origen_lead = document.querySelector('select[name="origen_lead"]').value;
            return data;
        }

        function showSuccessDialog(message, elegibleCredito) {
            const dialog = document.getElementById('successDialog');
            const dialogContent = dialog.querySelector('.relative.bg-card');

            const iconBg = elegibleCredito ? 'bg-green-100' : 'bg-yellow-100';
            const iconColor = elegibleCredito ? 'text-green-600' : 'text-yellow-600';
            const title = elegibleCredito ? '¡Listo!' : 'Información Importante';

            dialogContent.innerHTML = `
                <div class="w-16 h-16 ${iconBg} rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 ${iconColor}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        ${elegibleCredito
                            ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>'
                            : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>'
                        }
                    </svg>
                </div>
                <h2 class="text-xl font-headline font-bold text-foreground mb-2">${title}</h2>
                <p class="text-muted-foreground mb-6">${message}</p>
                <button onclick="window.location.reload()" class="w-full inline-flex items-center justify-center rounded-md text-sm font-medium bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2">Entendido</button>
            `;

            dialog.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeSuccessDialog() {
            document.getElementById('successDialog').classList.add('hidden');
            document.body.style.overflow = '';
        }

        // Variable para rastrear si crédito está bloqueado
        let creditoBloqueado = false;

        // Obtener clave única para localStorage basada en la cédula
        function getStorageKey() {
            const urlParams = new URLSearchParams(window.location.search);
            const cedulaHash = Array.from(urlParams.keys())[0] || 'default';
            return `creditoBloqueado_${cedulaHash}`;
        }

        // Verificar si el crédito está bloqueado en localStorage
        function checkCreditoBloqueadoStorage() {
            const key = getStorageKey();
            const bloqueado = localStorage.getItem(key);
            if (bloqueado === 'true') {
                bloquearCredito(false); // false = no guardar de nuevo en localStorage
            }
        }

        function showSalarioBajoDialog() {
            document.getElementById('salarioBajoDialog').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeSalarioBajoDialog() {
            document.getElementById('salarioBajoDialog').classList.add('hidden');
            document.body.style.overflow = '';

            // Bloquear opción de crédito (y guardar en localStorage)
            bloquearCredito(true);

            // Volver al paso 1
            currentStep = 0;
            showStep(currentStep);

            // Limpiar selección de interés
            document.querySelectorAll('input[name="interes"]').forEach(input => {
                input.checked = false;
            });
        }

        function bloquearCredito(guardarEnStorage = true) {
            creditoBloqueado = true;

            // Guardar en localStorage para persistir después de recargar
            if (guardarEnStorage) {
                const key = getStorageKey();
                localStorage.setItem(key, 'true');
            }

            // Bloquear opción Crédito
            const creditoOption = document.getElementById('creditoOption');
            const creditoRadio = document.getElementById('creditoRadio');
            const creditoCard = document.getElementById('creditoCard');

            creditoRadio.disabled = true;
            creditoOption.classList.remove('cursor-pointer');
            creditoOption.classList.add('cursor-not-allowed', 'opacity-50');
            creditoCard.classList.add('bg-gray-100');
            creditoCard.classList.remove('hover:shadow-md');

            if (!document.getElementById('creditoBloqueadoMsg')) {
                const msg = document.createElement('p');
                msg.id = 'creditoBloqueadoMsg';
                msg.className = 'text-xs text-red-500 mt-1';
                msg.textContent = 'No disponible para tu rango salarial';
                creditoCard.appendChild(msg);
            }

            // Bloquear opción Ambos
            const ambosOption = document.getElementById('ambosOption');
            const ambosRadio = document.getElementById('ambosRadio');
            const ambosCard = document.getElementById('ambosCard');

            ambosRadio.disabled = true;
            ambosOption.classList.remove('cursor-pointer');
            ambosOption.classList.add('cursor-not-allowed', 'opacity-50');
            ambosCard.classList.add('bg-gray-100');
            ambosCard.classList.remove('hover:shadow-md');

            if (!document.getElementById('ambosBloqueadoMsg')) {
                const msg = document.createElement('p');
                msg.id = 'ambosBloqueadoMsg';
                msg.className = 'text-xs text-red-500 mt-1';
                msg.textContent = 'No disponible para tu rango salarial';
                ambosCard.appendChild(msg);
            }
        }

        function checkSalarioBajo() {
            const ingresoSelect = document.getElementById('ingresoSelect');
            const interes = document.querySelector('input[name="interes"]:checked')?.value;

            // Solo verificar si el interés incluye crédito
            if ((interes === 'credito' || interes === 'ambos') && ingresoSelect.value === '<300k') {
                showSalarioBajoDialog();
                return true;
            }
            return false;
        }

        function setupFileUpload(fieldName, acceptTypes) {
            const fileInput = document.getElementById(`${fieldName}File`);
            const dropZone = document.getElementById(`${fieldName}DropZone`);
            const placeholder = document.getElementById(`${fieldName}Placeholder`);
            const preview = document.getElementById(`${fieldName}Preview`);
            const removeBtn = document.getElementById(`${fieldName}Remove`);
            const fileName = document.getElementById(`${fieldName}FileName`);

            // Click to upload
            dropZone.addEventListener('click', () => {
                if (!preview.classList.contains('hidden')) return;
                fileInput.click();
            });

            // File selected
            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    handleFile(file, fieldName);
                }
            });

            // Drag and drop
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('border-primary', 'bg-accent');
            });

            dropZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                dropZone.classList.remove('border-primary', 'bg-accent');
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('border-primary', 'bg-accent');
                const file = e.dataTransfer.files[0];
                if (file) {
                    // Validate file type
                    const acceptedTypes = acceptTypes.split(',').map(t => t.trim());
                    const fileType = file.type;
                    const isValid = acceptedTypes.some(type => {
                        if (type.includes('*')) {
                            const baseType = type.split('/')[0];
                            return fileType.startsWith(baseType);
                        }
                        return fileType === type;
                    });

                    if (!isValid) {
                        showAlert(`Tipo de archivo no válido para ${fieldName}.`, 'error');
                        return;
                    }

                    // Set the file to the input
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    fileInput.files = dataTransfer.files;

                    handleFile(file, fieldName);
                }
            });

            // Remove file
            removeBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                fileInput.value = '';
                placeholder.classList.remove('hidden');
                preview.classList.add('hidden');
                if (fieldName === 'cedula') {
                    document.getElementById('cedulaImage').src = '';
                } else if (fieldName === 'recibo') {
                    document.getElementById('reciboImageContainer').classList.add('hidden');
                    document.getElementById('reciboPdfContainer').classList.add('hidden');
                    document.getElementById('reciboImage').src = '';
                }
            });
        }

        function handleFile(file, fieldName) {
            const placeholder = document.getElementById(`${fieldName}Placeholder`);
            const preview = document.getElementById(`${fieldName}Preview`);
            const fileName = document.getElementById(`${fieldName}FileName`);

            // Show filename
            fileName.textContent = file.name;

            // Show preview
            placeholder.classList.add('hidden');
            preview.classList.remove('hidden');

            // Handle image preview
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    if (fieldName === 'cedula') {
                        document.getElementById('cedulaImage').src = e.target.result;
                    } else if (fieldName === 'recibo') {
                        document.getElementById('reciboImageContainer').classList.remove('hidden');
                        document.getElementById('reciboPdfContainer').classList.add('hidden');
                        document.getElementById('reciboImage').src = e.target.result;
                    }
                };
                reader.readAsDataURL(file);
            } else if (file.type === 'application/pdf' && fieldName === 'recibo') {
                // Show PDF icon
                document.getElementById('reciboImageContainer').classList.add('hidden');
                document.getElementById('reciboPdfContainer').classList.remove('hidden');
            }
        }

        async function checkQuestionnaireStatus() {
            // Obtener cédula de la URL
            const urlParams = new URLSearchParams(window.location.search);
            const cedulaHash = Array.from(urlParams.keys())[0];

            if (!cedulaHash) {
                showAlert('No se proporcionó identificación válida.', 'error');
                document.getElementById('questionnaireForm').innerHTML = '<p class="text-center text-red-600">Enlace inválido</p>';
                return;
            }

            try {
                const response = await fetch(`/api/questionnaire/status?cedula=${encodeURIComponent(cedulaHash)}`);
                const data = await response.json();

                if (data.completed) {
                    // Ocultar formulario y mostrar mensaje
                    document.getElementById('questionnaireForm').innerHTML = `
                        <div class="text-center p-8">
                            <svg class="mx-auto h-16 w-16 text-green-500 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <h2 class="text-2xl font-bold text-foreground mb-2">Cuestionario ya completado</h2>
                            <p class="text-muted-foreground mb-4">Este cuestionario fue completado el ${new Date(data.completed_at).toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
                            <p class="text-sm text-muted-foreground">Si necesitas actualizar tu información, por favor contacta a nuestro equipo.</p>
                        </div>
                    `;
                    document.querySelector('.max-w-2xl.mx-auto.bg-card').classList.add('shadow-lg');
                }
            } catch (error) {
                console.error('Error verificando estado del cuestionario:', error);
                // Si hay error, dejar que continúe normalmente
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Verificar si el cuestionario ya fue completado
            checkQuestionnaireStatus();

            // Verificar si el crédito está bloqueado (persistido en localStorage)
            checkCreditoBloqueadoStorage();

            // Cargar configuraciones de préstamos desde la API
            loadLoanConfigurations();

            showStep(currentStep);
            renderCompanyOptions();
            document.querySelectorAll('input[name="interes"]').forEach(input => {
                input.addEventListener('change', (e) => {
                    // Si crédito está bloqueado y selecciona crédito o ambos, prevenir
                    if (creditoBloqueado && (e.target.value === 'credito' || e.target.value === 'ambos')) {
                        e.preventDefault();
                        e.target.checked = false;
                        showAlert('La opción de crédito no está disponible para tu rango salarial. Por favor selecciona Servicios Legales.');
                        return;
                    }
                    updateDynamicBlocks();
                });
            });
            // Tipo de crédito - actualizar montos
            const tipoCredInputs = document.querySelectorAll('input[name="tipo_credito"]');
            tipoCredInputs.forEach(function(input) {
                input.addEventListener('change', function() {
                    updateMontoOptions();
                });
            });
            // Salario - formatear y validar
            document.getElementById('salarioExacto').addEventListener('input', (e) => {
                const formatted = formatSalario(e.target.value);
                e.target.value = formatted;
                validateSalario();
            });
            // Rango de ingreso - validar salario y verificar salario bajo
            document.getElementById('ingresoSelect').addEventListener('change', () => {
                validateSalario();
                checkSalarioBajo();
            });
            document.getElementById('companyTrigger').addEventListener('click', (e) => {
                e.stopPropagation();
                toggleCompanyDropdown();
            });
            document.getElementById('companySearch').addEventListener('input', (e) => {
                renderCompanyOptions(e.target.value || '');
            });

            // Institución dropdown event listeners
            loadInstituciones();
            document.getElementById('institucionTrigger').addEventListener('click', (e) => {
                e.stopPropagation();
                toggleInstitucionDropdown();
            });
            document.getElementById('institucionSearch').addEventListener('input', (e) => {
                renderInstitucionOptions(e.target.value || '');
            });

            document.addEventListener('click', (e) => {
                // Cerrar company dropdown
                const companyDropdown = document.getElementById('companyDropdown');
                const companyContainer = document.getElementById('companyContainer');
                if (!companyContainer.contains(e.target)) {
                    companyDropdown.classList.add('hidden');
                }

                // Cerrar institucion dropdown
                const institucionDropdown = document.getElementById('institucionDropdown');
                const institucionContainer = document.getElementById('institucionContainer');
                if (institucionContainer && !institucionContainer.contains(e.target)) {
                    institucionDropdown.classList.add('hidden');
                }
            });
            document.getElementById('backBtn').addEventListener('click', () => {
                if (currentStep > 0) {
                    currentStep -= 1;
                    showStep(currentStep);
                }
            });
            document.getElementById('nextBtn').addEventListener('click', () => {
                if (!validateStep(currentStep)) return;
                if (currentStep < steps.length - 1) {
                    currentStep += 1;
                    showStep(currentStep);
                }
            });

            // File upload handlers
            setupFileUpload('cedula', 'image/*');
            setupFileUpload('recibo', 'image/*,application/pdf');
            document.getElementById('questionnaireForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!validateStep(3)) return;

                // Collect form data
                const data = collectData();
                const formData = new FormData();

                // Add all questionnaire data as JSON
                formData.append('questionnaire_data', JSON.stringify(data));

                // Add files
                const cedulaFile = document.getElementById('cedulaFile').files[0];
                const reciboFile = document.getElementById('reciboFile').files[0];
                formData.append('cedula_file', cedulaFile);
                formData.append('recibo_file', reciboFile);

                // Get cedula from URL (base64 encoded)
                const urlParams = new URLSearchParams(window.location.search);
                const cedulaHash = Array.from(urlParams.keys())[0];
                if (cedulaHash) {
                    try {
                        const cedula = atob(cedulaHash);
                        formData.append('cedula', cedula);
                    } catch (e) {
                        console.error('Error decoding cedula from URL');
                    }
                }

                // Submit to API
                try {
                    showAlert('Enviando información...', 'success');
                    const response = await fetch('/api/questionnaire/submit', {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        const result = await response.json();
                        showSuccessDialog(result.message, result.elegible_credito);
                    } else {
                        const error = await response.json();
                        showAlert(error.message || 'Error al enviar el formulario.', 'error');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    showAlert('Error de conexión. Intenta nuevamente.', 'error');
                }
            });
        });
    </script>
</body>
</html>
