<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Lead</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --background: 220 13% 97%;
            --foreground: 224 71.4% 4.1%;
            --card: 0 0% 100%;
            --card-foreground: 224 71.4% 4.1%;
            --primary: 209 78% 34%;
            --primary-foreground: 0 0% 100%;
            --secondary: 220 13% 91%;
            --secondary-foreground: 220 9% 38%;
            --muted: 220 13% 91%;
            --muted-foreground: 220 9% 45%;
            --accent: 220 14% 96%;
            --border: 220 13% 85%;
            --input: 220 13% 85%;
            --ring: 209 78% 34%;
            --radius: 0.5rem;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: hsl(var(--background));
        }

        /* Custom switch styles to match dashboard UI */
        .switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: hsl(var(--secondary));
            transition: .4s;
            border-radius: 24px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: hsl(var(--primary));
        }
        input:checked + .slider:before {
            transform: translateX(20px);
        }
        .hidden {
          display: none;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        headline: ['Space Grotesk', 'sans-serif'],
                    },
                    colors: {
                        background: 'hsl(var(--background))',
                        foreground: 'hsl(var(--foreground))',
                        card: 'hsl(var(--card))',
                        'card-foreground': 'hsl(var(--card-foreground))',
                        primary: 'hsl(var(--primary))',
                        'primary-foreground': 'hsl(var(--primary-foreground))',
                        secondary: 'hsl(var(--secondary))',
                        'secondary-foreground': 'hsl(var(--secondary-foreground))',
                        muted: 'hsl(var(--muted))',
                        'muted-foreground': 'hsl(var(--muted-foreground))',
                        accent: 'hsl(var(--accent))',
                        border: 'hsl(var(--border))',
                        input: 'hsl(var(--input))',
                        ring: 'hsl(var(--ring))',
                    },
                    borderRadius: {
                        lg: 'var(--radius)',
                        md: 'calc(var(--radius) - 2px)',
                        sm: 'calc(var(--radius) - 4px)',
                    }
                }
            }
        }
    </script>
</head>
<body class="min-h-screen flex items-center justify-center p-2 md:p-4">
    <div class="w-full max-w-lg">
        <div id="alert" class="hidden p-4 mb-4 text-sm rounded-lg" role="alert"></div>

        <div class="bg-card text-card-foreground rounded-xl border shadow-lg">
            <div class="p-4 md:p-6">
                <div class="text-center">
                    <h1 class="text-xl md:text-2xl font-headline font-bold text-primary">Planilla de Registro</h1>
                    <p class="text-muted-foreground text-xs md:text-sm mt-1">Complete los datos para iniciar el proceso.</p>
                </div>
            </div>

            <form id="leadForm" class="p-4 md:p-6 pt-0">
                <div class="space-y-4">
                    <div class="form-group">
                        <label for="cedula" class="block text-sm font-medium text-foreground mb-1">Cédula *</label>
                        <input type="text" id="cedula" name="cedula" placeholder="Digite su cedula" minlength="6" maxlength="9" required class="w-full px-3 py-2 bg-background border border-input rounded-md text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2">
                        <p id="cedula-error" class="hidden text-xs text-red-500 mt-1"></p>
                        <p id="tseLoading" class="hidden text-xs text-primary mt-1">Buscando en TSE...</p>
                    </div>

                    <div id="tseInfo" class="hidden p-3 bg-accent rounded-md border">
                        <p class="text-sm font-medium"><strong>Nombre:</strong> <span id="tseNombre"></span></p>
                        <p class="text-sm font-medium"><strong>Apellidos:</strong> <span id="tseApellidos"></span></p>
                    </div>

                    <div id="tseConfirmation" class="hidden flex flex-col sm:flex-row items-center justify-between gap-3 p-4 border rounded-lg bg-background">
                         <span class="text-sm font-medium text-foreground text-center sm:text-left" id="tseConfirmationLabel"></span>
                         <div class="flex items-center gap-2 flex-shrink-0">
                            <button type="button" id="tseConfirmNoBtn" class="px-4 py-1.5 text-sm font-semibold text-white bg-red-600 hover:bg-red-700 rounded-md shadow-sm">No</button>
                            <button type="button" id="tseConfirmYesBtn" class="px-4 py-1.5 text-sm font-semibold text-white bg-green-600 hover:bg-green-700 rounded-md shadow-sm">Sí</button>
                         </div>
                    </div>


                    <div id="extranjeroSwitch" class="hidden flex items-center justify-between p-4 border rounded-lg bg-background">
                        <label for="isExtranjero" class="text-sm font-medium text-foreground">¿La cédula es de un extranjero?</label>
                        <label class="switch">
                            <input type="checkbox" id="isExtranjero">
                            <span class="slider"></span>
                        </label>
                    </div>

                    <div id="extranjeroFields" class="hidden space-y-4">
                        <div class="form-group">
                            <label for="nombre" class="block text-sm font-medium text-foreground mb-1">Nombre *</label>
                            <input type="text" id="nombre" name="nombre" placeholder="Nombre completo" class="w-full px-3 py-2 bg-background border border-input rounded-md text-sm">
                            <p id="nombre-error" class="hidden text-xs text-red-500 mt-1"></p>
                        </div>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div class="form-group">
                                <label for="apellido1" class="block text-sm font-medium text-foreground mb-1">Primer Apellido *</label>
                                <input type="text" id="apellido1" name="apellido1" placeholder="Primer apellido" class="w-full px-3 py-2 bg-background border border-input rounded-md text-sm">
                                <p id="apellido1-error" class="hidden text-xs text-red-500 mt-1"></p>
                            </div>
                            <div class="form-group">
                                <label for="apellido2" class="block text-sm font-medium text-foreground mb-1">Segundo Apellido</label>
                                <input type="text" id="apellido2" name="apellido2" placeholder="Segundo apellido" class="w-full px-3 py-2 bg-background border border-input rounded-md text-sm">
                                 <p id="apellido2-error" class="hidden text-xs text-red-500 mt-1"></p>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="genero" class="block text-sm font-medium text-foreground mb-1">Género</label>
                            <select id="genero" name="genero" class="w-full px-3 py-2 bg-background border border-input rounded-md text-sm">
                                <option value="">Seleccione el género</option>
                                <option value="1">Masculino</option>
                                <option value="2">Femenino</option>
                            </select>
                            <p id="genero-error" class="hidden text-xs text-red-500 mt-1"></p>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="email" class="block text-sm font-medium text-foreground mb-1">Correo Electrónico *</label>
                        <input type="email" id="email" name="email" placeholder="correo@ejemplo.com" required class="w-full px-3 py-2 bg-background border border-input rounded-md text-sm">
                        <p id="email-error" class="hidden text-xs text-red-500 mt-1"></p>
                    </div>

                     <div class="grid md:grid-cols-2 gap-4">
                        <div class="form-group">
                            <label for="phone" class="block text-sm font-medium text-foreground mb-1">Teléfono (WhatsApp) *</label>
                            <input type="tel" id="phone" name="phone" placeholder="88887777" minlength="7"maxlength="15" required class="w-full px-3 py-2 bg-background border border-input rounded-md text-sm">
                            <p id="phone-error" class="hidden text-xs text-red-500 mt-1"></p>
                        </div>
                        <div class="form-group">
                            <label for="sector" class="block text-sm font-medium text-foreground mb-1">Sector Laboral *</label>
                            <select id="sector" name="sector" required class="w-full px-3 py-2 bg-background border border-input rounded-md text-sm">
                                <option value="">Seleccione un sector</option>
                                <option value="publico">Sector Público</option>
                                <option value="privado">Sector Privado</option>
                                <option value="otro">Independiente / Propio</option>
                            </select>
                            <p id="sector-error" class="hidden text-xs text-red-500 mt-1"></p>
                        </div>
                    </div>
                </div>

                <div class="pt-6">
                     <button type="submit" id="submitBtn" class="w-full inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2">
                        Registrar Lead
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE_URL = window.location.origin;
        const TSE_API_URL = 'https://www.dsf.cr/tse/';

        let tseData = null;
        let tseLookupDone = false;
        let lastCedulaLookup = '';
        let userConfirmedTse = false;

        const formFieldsToManage = ['nombre', 'apellido1', 'apellido2', 'email', 'phone', 'sector', 'genero'];

        function setFieldsDisabled(disabled) {
            formFieldsToManage.forEach(id => {
                const field = document.getElementById(id);
                if (field) {
                    field.disabled = disabled;
                    field.classList.toggle('disabled:opacity-70', disabled);
                }
            });
            document.getElementById('submitBtn').disabled = disabled;
            document.getElementById('submitBtn').classList.toggle('disabled:opacity-70', disabled);
        }

        document.addEventListener('DOMContentLoaded', () => {
            setFieldsDisabled(true);
            document.getElementById('extranjeroFields').classList.add('hidden');
        });

        document.getElementById('cedula').addEventListener('input', function(e) {
            const rawCedula = e.target.value.replace(/[^0-9]/g, '');
            if (rawCedula.length >= 6 && rawCedula !== lastCedulaLookup) {
                lastCedulaLookup = rawCedula;
                lookupTSE(rawCedula);
            } else if (rawCedula.length < 9 && lastCedulaLookup) {
                resetForm();
                document.getElementById('cedula').value = rawCedula;
            }
        });

        async function lookupTSE(cedula) {
            resetForm(false);
            document.getElementById('tseLoading').classList.remove('hidden');

            try {
                const response = await fetch(TSE_API_URL + cedula);
                const data = await response.json();
                document.getElementById('tseLoading').classList.add('hidden');

                if (data.success && data.nombre) {
                    tseData = {
                        nombre: data.nombre,
                        apellido1: data.apellido1,
                        apellido2: data.apellido2,
                        fechaNacimiento: data['fecha-nacimiento'],
                        genero: data.sexo
                    };
                    tseLookupDone = true;
                    document.getElementById('tseNombre').textContent = data.nombre;
                    document.getElementById('tseApellidos').textContent = (data.apellido1 || '') + ' ' + (data.apellido2 || '');
                    document.getElementById('tseInfo').classList.remove('hidden');
                    document.getElementById('tseConfirmationLabel').textContent = `¿Eres ${data.nombre} ${data.apellido1}?`;
                    document.getElementById('tseConfirmation').classList.remove('hidden');
                } else {
                    tseLookupDone = true;
                    document.getElementById('extranjeroSwitch').classList.remove('hidden');
                    setFieldsDisabled(false);
                }
            } catch (error) {
                console.error('Error consultando TSE:', error);
                document.getElementById('tseLoading').classList.add('hidden');
                tseLookupDone = true;
                document.getElementById('extranjeroSwitch').classList.remove('hidden');
                setFieldsDisabled(false);
            }
        }

        document.getElementById('tseConfirmYesBtn').addEventListener('click', function() {
            userConfirmedTse = true;
            document.getElementById('tseConfirmation').classList.add('hidden');
            ['email', 'phone', 'sector'].forEach(id => document.getElementById(id).disabled = false);
            document.getElementById('submitBtn').disabled = false;
            document.getElementById('extranjeroFields').classList.add('hidden');
            ['nombre', 'apellido1', 'apellido2'].forEach(id => document.getElementById(id).disabled = true);
        });

        document.getElementById('tseConfirmNoBtn').addEventListener('click', function() {
            userConfirmedTse = false;
            tseData = null;
            document.getElementById('tseInfo').classList.add('hidden');
            document.getElementById('tseConfirmation').classList.add('hidden');
            document.getElementById('extranjeroFields').classList.remove('hidden');
            setFieldsDisabled(false);
        });

        document.getElementById('isExtranjero').addEventListener('change', function(e) {
            const fields = document.getElementById('extranjeroFields');
            if (e.target.checked) {
                fields.classList.remove('hidden');
                 ['nombre', 'apellido1', 'apellido2'].forEach(id => document.getElementById(id).disabled = false);
            } else {
                fields.classList.add('hidden');
            }
        });

        document.getElementById('phone').addEventListener('input', function(e) {
            e.target.value = e.target.value.replace(/[^0-9]/g, '').slice(0, 8);
        });

        function showAlert(message, type) {
            const alert = document.getElementById('alert');
            alert.textContent = message;
            alert.className = `p-4 mb-4 text-sm rounded-lg ${type === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`;
            alert.classList.remove('hidden');
            if (type === 'success') {
                setTimeout(() => alert.classList.add('hidden'), 5000);
            }
        }

        function showFieldError(field, message) {
            const errorEl = document.getElementById(field + '-error');
            if (errorEl) {
                errorEl.textContent = message;
                errorEl.classList.remove('hidden');
            }
            const inputEl = document.getElementById(field);
            if (inputEl) {
                 inputEl.classList.add('border-red-500');
            }
        }

        function clearErrors() {
            document.querySelectorAll('[id$="-error"]').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('input, select').forEach(el => el.classList.remove('border-red-500'));
             document.getElementById('alert').classList.add('hidden');
        }

        function validateForm(data) {
            let isValid = true;
            clearErrors();
            if (!/^\d{9}$/.test(data.cedula.replace(/[^0-g]/, ''))) {
                showFieldError('cedula', 'La cédula debe tener 9 dígitos.');
                isValid = false;
            }
            if (!userConfirmedTse && !document.getElementById('isExtranjero').checked) {
                if (!data.name || data.name.trim() === '') {
                    showFieldError('nombre', 'El nombre es requerido.');
                    isValid = false;
                }
                if (!data.apellido1 || data.apellido1.trim() === '') {
                    showFieldError('apellido1', 'El primer apellido es requerido.');
                    isValid = false;
                }
                if (!data.genero) {
                    showFieldError('genero', 'Seleccione un género.');
                    isValid = false;
                }
            }
             if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(data.email)) {
                showFieldError('email', 'Ingrese un correo válido.');
                isValid = false;
            }
            if (!/^\d{8}$/.test(data.phone)) {
                showFieldError('phone', 'El teléfono debe tener 8 dígitos.');
                isValid = false;
            }
            if (!data.sector) {
                showFieldError('sector', 'Seleccione un sector laboral.');
                isValid = false;
            }
            return isValid;
        }

        function resetForm(fullReset = true) {
            if (fullReset) {
                document.getElementById('leadForm').reset();
                lastCedulaLookup = '';
            }
            clearErrors();
            setFieldsDisabled(true);
            tseData = null;
            userConfirmedTse = false;
            tseLookupDone = false;
            document.getElementById('tseInfo').classList.add('hidden');
            document.getElementById('tseLoading').classList.add('hidden');
            document.getElementById('tseConfirmation').classList.add('hidden');
            document.getElementById('extranjeroSwitch').classList.add('hidden');
            document.getElementById('extranjeroFields').classList.add('hidden');
            document.getElementById('isExtranjero').checked = false;
        }

        document.getElementById('leadForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = {
                cedula: document.getElementById('cedula').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                sector: document.getElementById('sector').value,
                whatsapp: document.getElementById('phone').value
            };
            if (userConfirmedTse && tseData) {
                formData.name = tseData.nombre;
                formData.apellido1 = tseData.apellido1;
                formData.apellido2 = tseData.apellido2;
                formData.genero = tseData.genero;
                if (tseData.fechaNacimiento && tseData.fechaNacimiento !== 'fallecido') {
                    formData.fecha_nacimiento = tseData.fechaNacimiento;
                }
            } else {
                formData.name = document.getElementById('nombre').value;
                formData.apellido1 = document.getElementById('apellido1').value;
                formData.apellido2 = document.getElementById('apellido2').value;
                formData.genero = document.getElementById('genero').value;
            }

            if (!validateForm(formData)) return;

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Registrando...';

            try {
                const response = await fetch(`${API_BASE_URL}/api/leads`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                    body: JSON.stringify(formData)
                });
                const result = await response.json();
                                if (response.ok) {
                                    showAlert(`Lead registrado exitosamente!${result.opportunity ? ' Se creo una oportunidad automaticamente.' : ''}`, 'success');
                                    resetForm(true);
                
                                    // --- Secondary POST request to n8n webhook ---
                                    try {
                                        const n8nResponse = await fetch('https://n8n.webhook.ssc.cr/webhook/estado', {
                                            method: 'POST',
                                            headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                                            body: JSON.stringify(formData)
                                        });
                                        if (n8nResponse.ok) {
                                            console.log('Successfully sent data to n8n webhook.');
                                        } else {
                                            console.error('Failed to send data to n8n webhook:', n8nResponse.status, n8nResponse.statusText);
                                        }
                                    } catch (n8nError) {
                                        console.error('Error sending data to n8n webhook:', n8nError);
                                    }
                                    // --- End Secondary POST request ---
                
                                } else {
                                     if (result.errors) {
                                        Object.keys(result.errors).forEach(field => showFieldError(field, result.errors[field][0]));
                                        showAlert('Por favor corrija los errores en el formulario.', 'error');
                                    } else {
                                        showAlert(result.message || 'Error al registrar el lead.', 'error');
                                    }
                                }            } catch (error) {
                console.error('Error:', error);
                showAlert('Error de conexión. Intente nuevamente.', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Registrar Lead';
            }
        });
    </script>
</body>
</html>

